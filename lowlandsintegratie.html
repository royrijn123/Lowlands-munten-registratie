<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NextDrink X Lowlands</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; }
button { -webkit-tap-highlight-color: transparent; transition: transform 0.1s, background 0.2s; }
button:hover { transform: scale(1.05); }
.tile:hover { background: #fde68a; transform: scale(1.03); }
.bg-lowlands { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #fbc2eb 100%); }
.text-lowlands { color: #4b0082; }
.confetti { position: fixed; width: 10px; height: 10px; opacity: 0.8; pointer-events: none; z-index: 1000; animation: fall 2s linear forwards; }
@keyframes fall { 0% {transform: translateY(0) rotate(0deg);} 100% {transform: translateY(600px) rotate(360deg); opacity:0;} }
</style>
</head>
<body class="min-h-screen bg-lowlands flex items-start justify-center p-6">

<main class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6">

<header class="flex items-center gap-3 mb-5">
<img id="logo" src="images/nextdrink-logo.png" alt="NextDrink" class="w-14 h-14 rounded-lg object-cover"/>
<div>
<h1 class="text-2xl font-bold text-lowlands">NextDrink x Lowlands</h1>
<p id="menuSubtitle" class="text-sm text-purple-700">Kies je drankje ğŸ¹</p>
</div>
</header>

<!-- NAME SETUP -->
<section id="nameSetup" class="text-center hidden">
<h3 id="nameSetupTitle" class="text-xl font-bold text-lowlands mb-2"></h3>
<p id="nameSetupText" class="text-purple-700 mb-3"></p>
<div class="mt-3">
<input id="nameInput" type="text" placeholder="Voer naam in" class="w-full py-2 px-3 rounded-lg border border-gray-300 mb-2 text-gray-700">
<button id="nameContinueBtn" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
</div>
</section>

<!-- MENU -->
<section id="menu" class="hidden">
<h2 id="menuTitle" class="text-lg font-semibold text-lowlands mb-3"></h2>
<div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>
<div class="grid grid-cols-1 gap-3">
<button id="addDrinkBtn" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-800 font-semibold shadow hover:bg-yellow-300">+ Drankje toevoegen</button>
<button id="bestelOverzichtBtn" class="w-full py-3 rounded-xl bg-green-400 text-white font-bold shadow hover:bg-green-300">ğŸ“ Bekijk bestellijst</button>
<div class="flex gap-3 mt-2">
<button id="scoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold shadow hover:bg-pink-300">ğŸ“Š Tussenstand</button>
<button id="finalBtn" class="flex-1 py-3 rounded-xl bg-purple-500 text-white font-bold shadow hover:bg-purple-400">ğŸ Eindafrekening</button>
</div>
</div>
</section>

<!-- CONFIRM -->
<section id="confirm" class="hidden text-center">
<div class="text-5xl">âœ…</div>
<div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
<div class="mt-4 flex gap-3">
<button id="newRoundBtn" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Nieuw rondje ğŸ‰</button>
<button id="confirmScoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold hover:bg-pink-300">Tussenstand ğŸ“Š</button>
</div>
</section>

<!-- SCORES -->
<section id="scores" class="hidden">
<h3 class="text-lowlands font-bold mb-2">Tussenstand</h3>
<div id="scoreList" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromScores" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- BESTELLIJST -->
<section id="bestellijst" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ“ Bestellijst</h3>
<div id="bestellijstContent" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromBestel" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- FINAL -->
<section id="final" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ Eindafrekening</h3>
<div id="finalTotals" class="text-purple-800"></div>
<div id="finalSettlements" class="text-purple-800 mt-2"></div>
<div id="finalSettlementStatus" class="text-purple-800 mt-2"></div>
<div class="mt-4 flex gap-2">
<button id="markPaidBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Ik wil afrekenen ğŸ’¸</button>
<button id="backToMenuFromFinal" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
<div class="text-center text-white">
<div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
<div id="loadingText" class="mt-3">Bezig met laden...</div>
</div>
</div>

</main>

<script>
const $=id=>document.getElementById(id);
const apiUrl="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // vervang door jouw script
let chipId=new URLSearchParams(window.location.search).get('chipId');
if(!chipId){alert('Geen chipId!'); throw new Error('Geen chipId');}
let scannerName=localStorage.getItem('scannerName')||'';
let chipOwner='';
let drinks=[{name:"Bier",price:3},{name:"Wijn",price:4},{name:"Cocktail",price:5}];
let settlementPollInterval=null;
const cacheTTL=10000; // 10 sec caching

function showLoading(show,text='Bezig...'){
  $('loadingOverlay').style.display=show?'flex':'none';
  $('loadingText').textContent=text;
  document.querySelectorAll('button').forEach(b=>b.disabled=show);
}
function hideAll(){['menu','confirm','scores','final','nameSetup','bestellijst'].forEach(id=>{$(id)?.classList.add('hidden');});}
function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function confettiBurst(){for(let i=0;i<30;i++){const d=document.createElement('div');d.className='confetti';d.style.left=Math.random()*window.innerWidth+'px';d.style.background=`hsl(${Math.random()*360},80%,60%)`;d.style.animationDuration=(Math.random()*1+1.5)+'s';document.body.appendChild(d);setTimeout(()=>d.remove(),2000);}

// caching
function cacheGet(key){try{const raw=sessionStorage.getItem(key);if(!raw)return null;const {data,time}=JSON.parse(raw);if(Date.now()-time>cacheTTL)return null;return data;}catch(e){return null;}}
function cacheSet(key,data){try{sessionStorage.setItem(key,JSON.stringify({data,time:Date.now()}));}catch(e){}}

// INIT
async function init(){
  let title='',text='';
  if(!scannerName && !chipOwner){ title="Wat is je naam?"; text="Je naam wordt opgeslagen voor deze sessie.";}
  else if(chipOwner && !scannerName){ title=`Je hebt de chip van ${chipOwner} gescand.`; text="Wat is jouw eigen naam?";}
  else if(scannerName && !chipOwner){ title="Wiens chip heb je gescand?"; text="Voer de naam in van de eigenaar van de chip.";}
  $('nameSetupTitle').textContent = title;
  $('nameSetupText').textContent = text;
  $('nameSetup').classList.remove('hidden');
}

// Naam setup
$('nameContinueBtn').onclick = () => {
  const val = $('nameInput').value.trim();
  if(!val){alert('Vul een naam in!'); return;}
  if(!scannerName) {scannerName = val; localStorage.setItem('scannerName',scannerName);}
  else chipOwner = val;
  $('nameInput').value='';
  $('nameSetup').classList.add('hidden');
  renderMenu();
};

// render menu
function renderMenu(){
  hideAll();
  $('menuTitle').textContent = `Wat wil je dat ${chipOwner||'de persoon'} voor je haalt?`;
  const div = $('drinks'); div.innerHTML='';
  drinks.forEach(d=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
    btn.innerHTML=`<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">â‚¬${Number(d.price).toFixed(2)}</div>`;
    btn.onclick = ()=>placeOrder(d);
    div.appendChild(btn);
  });
  $('menu').classList.remove('hidden');
}

// order
async function placeOrder(drink){
  showLoading(true,'Verwerken...');
  try{
    await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'addScan',chipId,scanner:scannerName,drink:drink.name,amount:drink.price})});
    $('confirmText').innerHTML=`${escapeHtml(drink.name)} (â‚¬${Number(drink.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner||'de persoon')}.`;
    hideAll(); $('confirm').classList.remove('hidden'); confettiBurst();
    cacheSet('scans', null); // clear cache zodat realtime refresh
  }catch(e){console.error(e);alert('Fout bij plaatsen order.');}finally{showLoading(false);}
}

// Realtime data fetch
async function fetchCachedData(action){
  let cached = cacheGet(action);
  if(cached) return cached;
  const resp = await fetch(`${apiUrl}?action=${action}`);
  const data = await resp.json();
  cacheSet(action,data);
  return data;
}

// Bestellijst
async function showBestellijst(){
  showLoading(true);
  try{
    const scans = await fetchCachedData('getScans');
    const html = scans.filter(s=>s.owner===chipOwner).map(s=>`<p>${s.scanner} haalde ${s.drink} (â‚¬${Number(s.amount).toFixed(2)})</p>`).join('') || '<p>Nog geen bestellingen</p>';
    $('bestellijstContent').innerHTML=html;
    hideAll(); $('bestellijst').classList.remove('hidden');
  }catch(e){alert('Fout bij laden bestellijst');}finally{showLoading(false);}
}

// Scores
async function showScores(){
  showLoading(true);
  try{
    const scans = await fetchCachedData('getScans');
    const tally={};
    scans.forEach(s=>tally[s.owner]=(tally[s.owner]||0)+1);
    const html = '<ul>' + Object.entries(tally).map(([n,c])=>`<li>${escapeHtml(n)} â€” ${c} rondje${c===1?'':'s'}</li>`).join('') + '</ul>';
    $('scoreList').innerHTML=html;
    hideAll(); $('scores').classList.remove('hidden');
  }catch(e){alert('Fout bij laden scores');}finally{showLoading(false);}
}

// Eindafrekening
async function showFinal(){
  showLoading(true);
  try{
    const data = await fetchCachedData('getFinal');
    const htmlTotals = (data.result||[]).map(t=>`<p>${escapeHtml(t.name)} â€” â‚¬${Number(t.balance).toFixed(2)}</p>`).join('')||'<p>Nog geen data</p>';
    const htmlSettle = (data.settlements||[]).map(s=>`<p>${escapeHtml(s.from)} betaalt â‚¬${Number(s.amount).toFixed(2)} aan ${escapeHtml(s.to)}</p>`).join('')||'<p>Geen verrekeningen</p>';
    $('finalTotals').innerHTML=htmlTotals;
    $('finalSettlements').innerHTML=htmlSettle;
    hideAll(); $('final').classList.remove('hidden');
  }catch(e){alert('Fout bij laden eindafrekening');}finally{showLoading(false);}
}

// Event bindings
$('addDrinkBtn').onclick = () => {
  const name=prompt('Naam van het nieuwe drankje?'); if(!name)return;
  const price=parseFloat(prompt(`Prijs van "${name}"? (â‚¬)`)); if(isNaN(price)||price<=0)return;
  drinks.push({name:name.trim(),price}); renderMenu();
};
$('bestelOverzichtBtn').onclick = showBestellijst;
$('scoresBtn').onclick = showScores;
$('finalBtn').onclick = showFinal;
$('newRoundBtn').onclick = renderMenu;
$('confirmScoresBtn').onclick = showScores;
$('backToMenuFromScores').onclick = renderMenu;
$('backToMenuFromBestel').onclick = renderMenu;
$('backToMenuFromFinal').onclick = renderMenu;
$('markPaidBtn').onclick = async ()=>{
  showLoading(true);
  try{ await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'markAsPaid',name:scannerName})});
        alert('Afrekening bevestigd!'); showFinal();
  }catch(e){alert('Fout bij afrekenen');}finally{showLoading(false);}
};

// Auto-refresh intervals
setInterval(()=>{
  if(!$('menu').classList.contains('hidden')) return; // only refresh when not in menu
  cacheSet('getScans', null); // clear cache
  if(!$('bestellijst').classList.contains('hidden')) showBestellijst();
  if(!$('scores').classList.contains('hidden')) showScores();
  if(!$('final').classList.contains('hidden')) showFinal();
}, 5000); // elke 5 sec

window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
