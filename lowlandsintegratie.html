<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NextDrink x Lowlands</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; }
button { -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
button:hover { transform: scale(1.03); }
.tile:hover { background: #fde68a; transform: scale(1.02); }
.bg-lowlands { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #fbc2eb 100%); }
.text-lowlands { color: #4b0082; }
</style>
</head>
<body class="min-h-screen bg-lowlands flex items-start justify-center p-6">

<main class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6">

<header class="flex items-center gap-3 mb-5">
<img id="logo" src="images/nextdrink-logo.png" alt="NextDrink" class="w-14 h-14 rounded-lg object-cover"/>
<div>
<h1 class="text-2xl font-bold text-lowlands">NextDrink x Lowlands</h1>
<p id="menuSubtitle" class="text-sm text-purple-700">Kies je drankje ğŸ¹</p>
</div>
</header>

<!-- NAME INPUT SECTION -->
<section id="nameSection" class="text-center hidden">
<h3 id="nameTitle" class="text-xl font-bold text-lowlands mb-2"></h3>
<p id="nameText" class="text-purple-700 mb-3"></p>
<div class="mt-3">
<input id="nameInput" type="text" placeholder="Voer naam in" class="w-full py-2 px-3 rounded-lg border border-gray-300 mb-2 text-gray-700">
<button id="nameSubmitBtn" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
</div>
</section>

<!-- MENU -->
<section id="menu" class="hidden">
<h2 id="menuTitle" class="text-lg font-semibold text-lowlands mb-3"></h2>
<div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>
<div class="grid grid-cols-1 gap-3">
<button id="addDrinkBtn" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-800 font-semibold shadow hover:bg-yellow-300">+ Drankje toevoegen</button>
<button id="bestelOverzichtBtn" class="w-full py-3 rounded-xl bg-green-400 text-white font-bold shadow hover:bg-green-300">ğŸ“ Bekijk bestellijst</button>
<div class="flex gap-3 mt-2">
<button id="scoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold shadow hover:bg-pink-300">ğŸ“Š Tussenstand</button>
<button id="finalBtn" class="flex-1 py-3 rounded-xl bg-purple-500 text-white font-bold shadow hover:bg-purple-400">ğŸ Eindafrekening</button>
</div>
</div>
</section>

<!-- CONFIRM -->
<section id="confirm" class="hidden text-center">
<div class="text-5xl">âœ…</div>
<div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
<div class="mt-4 flex gap-3">
<button id="newRoundBtn" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Nieuw rondje ğŸ‰</button>
<button id="confirmScoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold hover:bg-pink-300">Tussenstand ğŸ“Š</button>
</div>
</section>

<!-- SCORES -->
<section id="scores" class="hidden">
<h3 class="text-lowlands font-bold mb-2">Tussenstand</h3>
<div id="scoreList" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromScores" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- BESTELLIJST -->
<section id="bestellijst" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ“ Bestellijst</h3>
<div id="bestellijstContent" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromBestel" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- FINAL -->
<section id="final" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ Eindafrekening</h3>
<div id="finalTotals" class="text-purple-800"></div>
<div id="finalSettlements" class="text-purple-800 mt-2"></div>
<div id="finalSettlementStatus" class="text-purple-800 mt-2"></div>
<div class="mt-4 flex gap-2">
<button id="markPaidBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Ik wil afrekenen ğŸ’¸</button>
<button id="backToMenuFromFinal" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- LOADING -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
<div class="text-center text-white">
<div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
<div id="loadingText" class="mt-3">Bezig met laden...</div>
</div>
</div>

</main>

<script>
const $ = id => document.getElementById(id);
const apiUrl = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
let chipId = new URLSearchParams(window.location.search).get('chipId');
if(!chipId){alert('Geen chipId in URL!'); throw new Error('Geen chipId');}

let scannerName = localStorage.getItem('scannerName') || '';
let chipOwner = '';
let drinks = [];

// ---------------- HELPERS ----------------
function showLoading(show,text='Bezig...'){
  $('loadingOverlay').style.display = show?'flex':'none';
  $('loadingText').textContent = text;
  document.querySelectorAll('button').forEach(b=>b.disabled=show);
}
function hideAll(){
  ['menu','confirm','scores','final','nameSection','bestellijst'].forEach(id=>{
    const el=$(id);
    if(el) el.classList.add('hidden');
  });
}
function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ---------------- INIT ----------------
async function init(){
  showLoading(true,'Initialiseren...');
  try{
    // chipOwner ophalen
    const ownerResp = await fetch(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
    chipOwner = (await ownerResp.text()).trim();

    // drinks ophalen
    const drinksResp = await fetch(`${apiUrl}?action=getDrinks`);
    drinks = await drinksResp.json();
    if(!drinks || !drinks.length) drinks = [{name:'Bier',price:3},{name:'Wijn',price:4},{name:'Cocktail',price:5}];

    // ------------- NAAM INVOER LOGICA ----------------
    hideAll();
    $('nameSection').classList.remove('hidden');
    const nameTitle = $('nameTitle');
    const nameText = $('nameText');
    const nameInput = $('nameInput');

    if(!scannerName && !chipOwner){
      nameTitle.textContent = "Welkom!";
      nameText.textContent = "Voer hier je naam in om te beginnen.";
    } else if(chipOwner && !scannerName){
      nameTitle.textContent = `Je hebt de chip van ${chipOwner} gescand.`;
      nameText.textContent = "Wat is jouw naam?";
    } else if(scannerName && !chipOwner){
      nameTitle.textContent = "Wiens chip heb je gescand?";
      nameText.textContent = "Voer de naam in van de eigenaar van de chip.";
    } else {
      // beide bekend
      renderMenu();
      return showLoading(false);
    }

    $('nameSubmitBtn').onclick = async ()=>{
      const val = nameInput.value.trim();
      if(!val){alert('Vul een naam in!'); return;}

      if(!scannerName && !chipOwner){
        scannerName = val;
        chipOwner = val;
        localStorage.setItem('scannerName', scannerName);
        try{
          await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})});
        }catch(e){console.warn(e);}
      } else if(chipOwner && !scannerName){
        scannerName = val;
        localStorage.setItem('scannerName', scannerName);
      } else if(scannerName && !chipOwner){
        chipOwner = val;
        try{
          await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})});
        }catch(e){console.warn(e);}
      }
      nameInput.value='';
      hideAll();
      renderMenu();
    }

  }catch(err){console.error(err); alert('Fout bij initialiseren.');}
  finally{showLoading(false);}
}

// ---------------- MENU ----------------
function renderMenu(){
  hideAll();
  $('menuTitle').textContent = `Wat wil je dat ${chipOwner} voor je haalt?`;
  const div = $('drinks');
  div.innerHTML = '';
  drinks.forEach(d=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
    btn.innerHTML = `<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">â‚¬${Number(d.price).toFixed(2)}</div>`;
    btn.onclick = ()=>placeOrder(d);
    div.appendChild(btn);
  });
  $('menu').classList.remove('hidden');
}

// ---------------- PLACE ORDER ----------------
async function placeOrder(drink){
  showLoading(true,'Verwerken...');
  try{
    await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'addScan',chipId,scanner:scannerName,drink:drink.name,amount:drink.price})});
    hideAll();
    $('confirmText').innerHTML=`${escapeHtml(drink.name)} (â‚¬${Number(drink.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner)}.`;
    $('confirm').classList.remove('hidden');
  }catch(e){console.error(e);alert('Fout bij plaatsen order');}
  finally{showLoading(false);}
}

// ---------------- EVENT LISTENERS ----------------
window.addEventListener('DOMContentLoaded',init);
$('addDrinkBtn').onclick = async ()=>{
  const name = prompt('Naam nieuw drankje?'); if(!name) return;
  const price = parseFloat(prompt(`Prijs van ${name}? (â‚¬)`));
  if(isNaN(price)||price<=0) return alert('Ongeldige prijs!');
  drinks.push({name:name, price});
  renderMenu();
};
$('bestelOverzichtBtn').onclick = ()=>alert('Bestellijst nog niet geÃ¯mplementeerd in dit voorbeeld');
$('scoresBtn').onclick = ()=>alert('Tussenstand nog niet geÃ¯mplementeerd in dit voorbeeld');
$('finalBtn').onclick = ()=>alert('Eindafrekening nog niet geÃ¯mplementeerd in dit voorbeeld');
$('newRoundBtn').onclick = renderMenu;
$('confirmScoresBtn').onclick = ()=>alert('Tussenstand nog niet geÃ¯mplementeerd in dit voorbeeld');

</script>
</body>
</html>
