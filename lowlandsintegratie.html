<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NextDrink √ó Lowlands</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* ========== FONT STYLES ========== */
  @font-face {
    font-family: 'LLPixel';
    src: url('https://fonts.cdnfonts.com/s/90605/PressStart2P-Regular.woff2') format('woff2');
    font-display: swap;
  }
  body {
    font-family: 'Poppins', sans-serif;
    background-image: url('images/lowlands2025-bg.PNG');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
  }
  button, h1, h2, h3, .btn-font {
    font-family: 'LLPixel', monospace;
    text-transform: uppercase;
  }
  p, li, input, #scoreList, #bestellijstContent, #finalTotals, #finalSettlements {
    font-family: 'Poppins', sans-serif;
  }
  button { -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
  button:hover { transform: scale(1.03); }
  .tile:hover { background: #fde68a; transform: scale(1.02); }
  .text-lowlands { color: #4b0082; }

  /* ========== LOWLANDS ‚Äú√ó‚Äù ========== */
  .llx {
    width: 40px;
    height: 40px;
    display: inline-block;
    background: linear-gradient(135deg, #f6d365, #c77cff);
    -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M19 10a9 9 0 0 0-9 9v0c0 2.4 1 4.8 2.7 6.5L36 49 12.7 74.5A9.2 9.2 0 0 0 10 81a9 9 0 0 0 9 9h0c2.4 0 4.8-1 6.5-2.7L50 62.9l24.5 24.4A9.2 9.2 0 0 0 81 90a9 9 0 0 0 9-9v0c0-2.4-1-4.8-2.7-6.5L62.9 50 87.3 25.5A9.2 9.2 0 0 0 90 19a9 9 0 0 0-9-9h0c-2.4 0-4.8 1-6.5 2.7L50 37.1 25.5 12.7A9.2 9.2 0 0 0 19 10Z"/></svg>') center / contain no-repeat;
            mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M19 10a9 9 0 0 0-9 9v0c0 2.4 1 4.8 2.7 6.5L36 49 12.7 74.5A9.2 9.2 0 0 0 10 81a9 9 0 0 0 9 9h0c2.4 0 4.8-1 6.5-2.7L50 62.9l24.5 24.4A9.2 9.2 0 0 0 81 90a9 9 0 0 0 9-9v0c0-2.4-1-4.8-2.7-6.5L62.9 50 87.3 25.5A9.2 9.2 0 0 0 90 19a9 9 0 0 0-9-9h0c-2.4 0-4.8 1-6.5 2.7L50 37.1 25.5 12.7A9.2 9.2 0 0 0 19 10Z"/></svg>') center / contain no-repeat;
  }

  /* INPUT FIXES */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] { appearance: textfield; }
  #newDrinkName, #newDrinkPrice {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #d1d5db;
    width: 100%;
  }

  main {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(8px);
  }
</style>
</head>

<body class="min-h-screen flex items-start justify-center p-6">

<main class="w-full max-w-md rounded-3xl shadow-2xl p-6">

  <!-- HEADER -->
  <header class="flex items-center justify-center gap-3 mb-5">
    <img src="images/nextdrink-logo.png" alt="NextDrink" class="w-12 h-12 rounded-lg object-cover"/>
    <span class="llx" aria-hidden="true"></span>
    <img src="images/logo-ll26.PNG" alt="LL26" class="w-12 h-12 rounded-lg object-cover"/>
  </header>

  <!-- FIRST TIME -->
  <section id="firstTime" class="text-center hidden">
    <h3 class="text-xl font-bold text-lowlands mb-2">Welkom!</h3>
    <p class="text-purple-700 mb-3">Voer je naam in om te starten:</p>
    <input id="firstTimeNameInput" type="text" placeholder="Jouw naam" class="w-full p-3 rounded-xl border border-gray-300 mb-3">
    <button id="firstTimeContinueBtn" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
  </section>

  <!-- POST-NAME INSTRUCTIONS -->
  <section id="postName" class="hidden text-center">
    <div class="text-5xl mb-2">üéâ</div>
    <h3 class="text-lg font-semibold text-lowlands mb-2">Je bent klaar!</h3>
    <p class="text-purple-800">
      Haal de <strong>QR-code</strong> van je sticker en plak het andere deel <strong>onderin op de achterkant</strong> van je telefoon.
    </p>
    <button id="postNameContinueBtn" class="mt-4 w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
  </section>

  <!-- MENU -->
  <section id="menu" class="hidden">
    <h2 id="menuTitle" class="text-lg font-semibold text-lowlands mb-3"></h2>
    <div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>
    <div class="grid grid-cols-1 gap-3">
      <button id="newDrinkScreenBtn" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-800 font-semibold shadow hover:bg-yellow-300">+ Nieuw drankje</button>
      <button id="bestelOverzichtBtn" class="w-full py-3 rounded-xl bg-green-400 text-white font-bold shadow hover:bg-green-300">üìù Bekijk bestellijst</button>
      <div class="flex gap-3 mt-2">
        <button id="scoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold shadow hover:bg-pink-300">üìä Tussenstand</button>
        <button id="finalBtn" class="flex-1 py-3 rounded-xl bg-purple-500 text-white font-bold shadow hover:bg-purple-400">üèÅ Eindafrekening</button>
      </div>
    </div>
  </section>

  <!-- NEW DRINK -->
  <section id="newDrink" class="hidden">
    <h3 class="text-lowlands font-bold mb-3">Nieuw drankje toevoegen</h3>
    <div class="flex flex-col gap-3 mb-3">
      <input id="newDrinkName" type="text" placeholder="Naam nieuw drankje">
      <input id="newDrinkPrice" type="number" step="0.01" placeholder="Prijs (‚Ç¨)">
    </div>
    <div class="flex gap-2">
      <button id="addDrinkBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Opslaan</button>
      <button id="cancelNewDrinkBtn" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Annuleren</button>
    </div>
  </section>

  <!-- CONFIRM -->
  <section id="confirm" class="hidden text-center">
    <div class="text-5xl">‚úÖ</div>
    <div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
    <div class="mt-4 flex gap-3">
      <button id="newRoundBtn" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Nieuw rondje üéâ</button>
      <button id="confirmScoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold hover:bg-pink-300">Tussenstand üìä</button>
    </div>
  </section>

  <!-- SCORES -->
  <section id="scores" class="hidden">
    <h3 class="text-lowlands font-bold mb-2">Tussenstand</h3>
    <div id="scoreList" class="text-purple-800"></div>
    <div class="mt-4">
      <button id="backToMenuFromScores" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
    </div>
  </section>

  <!-- BESTELLIJST -->
  <section id="bestellijst" class="hidden">
    <h3 class="text-lowlands font-bold mb-2">üìù Bestellijst (laatste 30 min)</h3>
    <div id="bestellijstContent" class="text-purple-800"></div>
    <div class="mt-4">
      <button id="backToMenuFromBestel" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
    </div>
  </section>

  <!-- FINAL -->
  <section id="final" class="hidden">
    <h3 class="text-lowlands font-bold mb-2">üèÅ Eindafrekening</h3>
    <div id="finalTotals" class="text-purple-800"></div>
    <div id="finalSettlements" class="text-purple-800 mt-2"></div>
    <div id="finalSettlementStatus" class="text-purple-800 mt-2"></div>
    <div class="mt-4 flex gap-2">
      <button id="markPaidBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Ik wil afrekenen üí∏</button>
      <button id="backToMenuFromFinal" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
    </div>
  </section>

  <!-- LOADING -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="text-center text-white">
      <div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
      <div id="loadingText" class="mt-3">Bezig met laden...</div>
    </div>
  </div>
</main>

<script>
const $ = id => document.getElementById(id);
const apiUrl = "https://script.google.com/macros/s/AKfycbwW8-QL2zxIBhyy5NQGvmnhbX3Tm0cr7_71JJMfwy1Cad0jWCYyWyt18Qkny9gpksZG4w/exec";
const chipId = new URLSearchParams(window.location.search).get('chipId');
if (!chipId) { alert('Geen chipId in URL!'); throw new Error('Geen chipId'); }

let scannerName = localStorage.getItem('scannerName') || '';
let chipOwner = '';
let drinks = [];

function showLoading(show, text='Bezig...') {
  $('loadingOverlay').style.display = show ? 'flex' : 'none';
  $('loadingText').textContent = text;
  document.querySelectorAll('button').forEach(b => b.disabled = show);
}
async function fetchWithTimeout(url, options={}, timeout=8000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try { const res = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id); return res; }
  catch (err) { clearTimeout(id); throw err; }
}
function hideAll() {
  ['menu','confirm','scores','final','firstTime','bestellijst','newDrink','postName']
    .forEach(id => $(id)?.classList.add('hidden'));
}
function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

async function init() {
  showLoading(true,'Initialiseren...');
  try {
    const ownerResp = await fetchWithTimeout(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
    chipOwner = (await ownerResp.text()).trim();
    const drinksResp = await fetchWithTimeout(`${apiUrl}?action=getDrinks`);
    drinks = await drinksResp.json();
    if (!drinks?.length) drinks = [
      {name:'Kleine bier',price:4.4},{name:'Grote bier',price:8},
      {name:'Desperados',price:6.5},{name:'Wijn',price:6},
      {name:'0.0 bier',price:4},{name:'Frisdrank',price:4}
    ];
    if (!scannerName && !chipOwner) { hideAll(); $('firstTime').classList.remove('hidden'); return; }
    renderMenu();
  } catch (err) { console.error(err); alert('Fout bij initialiseren.'); }
  finally { showLoading(false); }
}

$('firstTimeContinueBtn').onclick = async () => {
  const name = $('firstTimeNameInput').value.trim();
  if (!name) { alert('Voer een naam in'); return; }
  showLoading(true,'Verwerken...');
  scannerName = chipOwner = name;
  localStorage.setItem('scannerName', scannerName);
  try {
    await fetch(apiUrl, { method:'POST', body: new URLSearchParams({action:'setOwner', chipId, owner:chipOwner}) });
    hideAll(); $('postName').classList.remove('hidden');
  } catch (e) { console.warn(e); renderMenu(); }
  finally { showLoading(false); }
};
$('postNameContinueBtn').onclick = () => { renderMenu(); };

$('newDrinkScreenBtn').onclick = () => { hideAll(); $('newDrink').classList.remove('hidden'); };
$('cancelNewDrinkBtn').onclick = () => { renderMenu(); };
$('addDrinkBtn').onclick = async () => {
  const name = $('newDrinkName').value.trim();
  const price = parseFloat($('newDrinkPrice').value);
  if (!name || isNaN(price) || price <= 0) { alert('Ongeldige naam of prijs'); return; }
  showLoading(true,'Opslaan...');
  drinks.push({ name, price });
  $('newDrinkName').value = ''; $('newDrinkPrice').value = '';
  try {
    await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'setDrinks', drinks:JSON.stringify(drinks)}) });
    renderMenu();
  } catch(e){ console.error(e); alert('Fout bij opslaan drankje'); }
  finally{ showLoading(false); }
};

function renderMenu() {
  hideAll();
  $('menuTitle').textContent = `Wat wil je dat ${chipOwner} voor je haalt?`;
  const div = $('drinks'); div.innerHTML = '';
  drinks.forEach(d => {
    const btn = document.createElement('button');
    btn.className = 'tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
    btn.innerHTML = `<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">‚Ç¨${Number(d.price).toFixed(2)}</div>`;
    btn.onclick = async () => {
      showLoading(true,'Verwerken...');
      try {
        await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'addScan', chipId, scanner:scannerName, drink:d.name, amount:d.price}) });
        $('confirmText').innerHTML = `${escapeHtml(d.name)} (‚Ç¨${Number(d.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner)}.`;
        hideAll(); $('confirm').classList.remove('hidden');
      } catch(e){ console.error(e); alert('Fout bij plaatsen order'); }
      finally{ showLoading(false); }
    };
    div.appendChild(btn);
  });
  $('menu').classList.remove('hidden');
}

$('bestelOverzichtBtn').onclick = async () => {
  showLoading(true,'Bestellijst laden...');
  try {
    const res = await fetch(`${apiUrl}?action=getScans`);
    const scans = await res.json();
    const now = Date.now(); const THIRTY_MIN = 30 * 60 * 1000;
    const recent = scans.filter(s => {
      if (s.owner !== chipOwner) return false;
      const t = new Date(s.timestamp || s.time || s.date || 0).getTime();
      return isFinite(t) ? (now - t) <= THIRTY_MIN : false;
    });
    const grouped = {};
    recent.forEach(s => {
      if (!grouped[s.scanner]) grouped[s.scanner] = {};
      grouped[s.scanner][s.drink] = (grouped[s.scanner][s.drink] || 0) + 1;
    });
    let html = '';
    if (recent.length === 0) {
      html = `<p>Geen recente bestellingen (laatste 30 minuten) voor <strong>${escapeHtml(chipOwner)}</strong>.</p>`;
    } else {
      html += `<p class="font-semibold">${escapeHtml(chipOwner)}</p>`;
      Object.entries(grouped).forEach(([scanner, drinksObj]) => {
        html += `<p class="mt-2 font-semibold">${escapeHtml(scanner)}</p><ul class="list-disc ml-5">`;
        Object.entries(drinksObj).forEach(([drinkName, count]) => html += `<li>${count} √ó ${escapeHtml(drinkName)}</li>`);
        html += `</ul>`;
      });
    }
    hideAll(); $('bestellijstContent').innerHTML = html; $('bestellijst').classList.remove('hidden');
  } catch(e){ console.error(e); alert('Fout bij laden bestellijst'); }
  finally{ showLoading(false); }
};
$('backToMenuFromBestel').onclick = renderMenu;
$('backToMenuFromScores').onclick = renderMenu;
$('newRoundBtn').onclick = renderMenu;
$('confirmScoresBtn').onclick = async () => { await showScores(); };
$('scoresBtn').onclick = async () => { await showScores(); };

async function showScores(){
  showLoading(true,'Tussenstand laden...');
  try {
    const res = await fetch(`${apiUrl}?action=getScores`);
    const scores = await res.json();
    let html = '<ul class="list-disc ml-5">';
    if (!scores.length) html += '<li>Nog geen data</li>';
    else scores.forEach(s => { html += `<li><strong>${escapeHtml(s.owner)}</strong> ‚Äî ${s.rounds} rondje${s.rounds===1?'':'s'}</li>`; });
    html += '</ul>';
    hideAll(); $('scoreList').innerHTML = html; $('scores').classList.remove('hidden');
  } catch(e){ console.error(e); alert('Fout bij laden tussenstand'); }
  finally{ showLoading(false); }
}

$('finalBtn').onclick = async () => { await showFinal(); };
$('backToMenuFromFinal').onclick = renderMenu;
$('markPaidBtn').onclick = async () => {
  showLoading(true,'Bezig met registreren...');
  try {
    await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'markAsPaid', name:scannerName}) });
    $('finalSettlementStatus').textContent = '‚úÖ Verzoek om af te rekenen verstuurd!';
  } catch(e){ console.error(e); alert('Fout bij afrekenen'); }
  finally{ showLoading(false); }
};

async function showFinal(){
  showLoading(true,'Eindafrekening laden...');
  try{
    const res = await fetch(`${apiUrl}?action=getFinal`);
    const data = await res.json();
    let htmlTotals = '';
    if (!data.result?.length) htmlTotals = '<p>Nog geen data</p>';
    else {
      htmlTotals += '<div class="font-semibold mb-2">Totaal uitgegeven per persoon:</div><ul class="list-disc ml-5">';
      data.result.forEach(t => { htmlTotals += `<li><strong>${escapeHtml(t.name)}</strong> ‚Äî ‚Ç¨${Number(t.balance).toFixed(2)}</li>`; });
      htmlTotals += '</ul>';
    }
    let htmlSettle = '';
    if (!data.settlements?.length) htmlSettle = '<p>Geen verrekeningen nodig.</p>';
    else {
      htmlSettle += '<div class="font-semibold mt-2">Verrekeningen</div><ul class="list-disc ml-5">';
      data.settlements.forEach(s => { htmlSettle += `<li>${escapeHtml(s.from)} betaalt ‚Ç¨${Number(s.amount).toFixed(2)} aan ${escapeHtml(s.to)}</li>`; });
      htmlSettle += '</ul>';
    }
    hideAll(); $('finalTotals').innerHTML = htmlTotals; $('finalSettlements').innerHTML = htmlSettle; $('final').classList.remove('hidden');
  } catch(e){ console.error(e); alert('Fout bij laden eindafrekening'); }
  finally{ showLoading(false); }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
