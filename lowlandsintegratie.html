<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NextDrink NFC â€” Lowlands Vibe</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; }
button { -webkit-tap-highlight-color: transparent; transition: transform 0.1s, background 0.2s; }
button:hover { transform: scale(1.05); }
.tile:hover { background: #fde68a; transform: scale(1.03); }
.bg-lowlands { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #fbc2eb 100%); }
.text-lowlands { color: #4b0082; }
.confetti { position: fixed; width: 10px; height: 10px; background: randomColor(); opacity: 0.8; pointer-events: none; z-index: 1000; animation: fall 2s linear forwards; }
@keyframes fall { 0% {transform: translateY(0) rotate(0deg);} 100% {transform: translateY(600px) rotate(360deg); opacity:0;} }
</style>
</head>
<body class="min-h-screen bg-lowlands flex items-start justify-center p-6">

<main class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6">

<header class="flex items-center gap-3 mb-5">
<img id="logo" src="images/nextdrink-logo.png" alt="NextDrink" class="w-14 h-14 rounded-lg object-cover"/>
<div>
<h1 class="text-2xl font-bold text-lowlands">NextDrink</h1>
<p id="menuSubtitle" class="text-sm text-purple-700">Laad je NFC-sticker en kies je drankje ğŸ¹</p>
</div>
</header>

<!-- MENU -->
<section id="menu" class="hidden">
<h2 id="menuTitle" class="text-lg font-semibold text-lowlands mb-3"></h2>
<div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>
<div class="grid grid-cols-1 gap-3">
<button id="addDrinkBtn" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-800 font-semibold shadow hover:bg-yellow-300">+ Drankje toevoegen</button>
<button id="bestelOverzichtBtn" class="w-full py-3 rounded-xl bg-green-400 text-white font-bold shadow hover:bg-green-300">ğŸ“ Bekijk bestellijst</button>
<div class="flex gap-3 mt-2">
<button id="scoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold shadow hover:bg-pink-300">ğŸ“Š Tussenstand</button>
<button id="finalBtn" class="flex-1 py-3 rounded-xl bg-purple-500 text-white font-bold shadow hover:bg-purple-400">ğŸ Eindafrekening</button>
</div>
</div>
</section>

<!-- FIRST TIME -->
<section id="firstTime" class="hidden text-center">
<h3 id="firstTimeTitle" class="text-xl font-bold text-lowlands mb-2"></h3>
<p id="firstTimeText" class="text-purple-700 mb-3"></p>
<div class="mt-3">
<button id="firstTimeContinueBtn" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
</div>
</section>

<!-- CONFIRM -->
<section id="confirm" class="hidden text-center">
<div class="text-5xl">âœ…</div>
<div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
<div class="mt-4 flex gap-3">
<button id="newRoundBtn" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Nieuw rondje ğŸ‰</button>
<button id="confirmScoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold hover:bg-pink-300">Tussenstand ğŸ“Š</button>
</div>
</section>

<!-- SCORES -->
<section id="scores" class="hidden">
<h3 class="text-lowlands font-bold mb-2">Tussenstand</h3>
<div id="scoreList" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromScores" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- BESTELLIJST -->
<section id="bestellijst" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ“ Bestellijst</h3>
<div id="bestellijstContent" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromBestel" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- FINAL -->
<section id="final" class="hidden">
<h3 class="text-lowlands font-bold mb-2">ğŸ Eindafrekening</h3>
<div id="finalTotals" class="text-purple-800"></div>
<div id="finalSettlements" class="text-purple-800 mt-2"></div>
<div id="finalSettlementStatus" class="text-purple-800 mt-2"></div>
<div class="mt-4 flex gap-2">
<button id="markPaidBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Ik wil afrekenen ğŸ’¸</button>
<button id="backToMenuFromFinal" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
<div class="text-center text-white">
<div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
<div id="loadingText" class="mt-3">Bezig met laden...</div>
</div>
</div>

</main>

<script>
const $=id=>document.getElementById(id);
const apiUrl="https://script.google.com/macros/s/AKfycbwW8-QL2zxIBhyy5NQGvmnhbX3Tm0cr7_71JJMfwy1Cad0jWCYyWyt18Qkny9gpksZG4w/exec";
const cacheTTL=30000;
let chipId=new URLSearchParams(window.location.search).get('chipId');
if(!chipId){alert('Geen chipId in URL!');throw new Error('Geen chipId');}
let scannerName=localStorage.getItem('scannerName')||'';
let chipOwner='';
let drinks=[];
let settlementPollInterval=null;

// ---------------- HELPER FUNCTIONS ----------------
function showLoading(show,text='Bezig...'){
$('loadingOverlay').style.display=show?'flex':'none';
$('loadingText').textContent=text;
document.querySelectorAll('button').forEach(b=>b.disabled=show);
}
async function fetchWithTimeout(url,options={},timeout=5000){
const controller=new AbortController();
const id=setTimeout(()=>controller.abort(),timeout);
try{const res=await fetch(url,{...options,signal:controller.signal}); clearTimeout(id); return res;}catch(err){clearTimeout(id); throw err;}
}
function cacheGet(key){try{const raw=sessionStorage.getItem(key);if(!raw)return null;const {data,time}=JSON.parse(raw);if(Date.now()-time>cacheTTL)return null;return data;}catch(e){return null;}}
function cacheSet(key,data){try{sessionStorage.setItem(key,JSON.stringify({data,time:Date.now()}));}catch(e){}}
function hideAll(){['menu','confirm','scores','final','firstTime','bestellijst'].forEach(id=>{const el=$(id);if(el)el.classList.add('hidden');});}
function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ---------------- CONFETTI EFFECT ----------------
function confettiBurst(){
for(let i=0;i<30;i++){
const div=document.createElement('div');div.className='confetti';div.style.left=Math.random()*window.innerWidth+'px';
div.style.background=`hsl(${Math.random()*360}, 80%, 60%)`;
div.style.animationDuration=(Math.random()*1+1.5)+'s';
document.body.appendChild(div);
setTimeout(()=>div.remove(),2000);
}
}

// ---------------- MAIN FUNCTIONS ----------------
async function init(){
showLoading(true,'Initialiseren...');
try{
const ownerResp=await fetchWithTimeout(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
chipOwner=(await ownerResp.text()).trim();
const drinksResp=await fetchWithTimeout(`${apiUrl}?action=getDrinks`);
drinks=await drinksResp.json();
if(!drinks||!drinks.length)drinks=[{name:'Kleine bier',price:4.4},{name:'Grote bier',price:8},{name:'Desperados',price:6.5},{name:'Wijn',price:6},{name:'0.0 bier',price:4},{name:'Frisdrank',price:4}];

// FIRST TIME LOGIC
if(!scannerName && !chipOwner){
$('firstTimeTitle').textContent='Welkom!';
$('firstTimeText').innerHTML='Hoi! Je naam wordt eerst opgeslagen.';
hideAll();$('firstTime').classList.remove('hidden');
$('firstTimeContinueBtn').onclick=async()=>{
const name=prompt('Wat is je naam?')?.trim();
if(!name){alert('Geen naam ingevoerd.'); return;}
scannerName=chipOwner=name;
localStorage.setItem('scannerName',scannerName);
try{await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})});}catch(e){console.warn(e);}
$('firstTimeText').innerHTML=`Hoi ${chipOwner}! Je naam is correct opgeslagen.<br/>Haal nu de QR code van de sticker af en plak de sticker onderin op de achterkant van je telefoon.`;
$('firstTimeContinueBtn').onclick=renderMenu;
};
showLoading(false); return;
}
if(chipOwner && !scannerName){
const name=prompt(`Je hebt de chip van ${chipOwner} gescand. Wat is jouw naam?`)?.trim();
if(!name){alert('Geen naam ingevoerd.'); return;}
scannerName=name;
localStorage.setItem('scannerName',scannerName);
}
if(scannerName && !chipOwner){
const ownerName=prompt('Wiens chip heb je gescand?')?.trim();
if(!ownerName){alert('Geen naam ingevoerd.'); return;}
chipOwner=ownerName;
try{await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})});}catch(e){console.warn(e);}
}
renderMenu();
}catch(err){console.error(err);alert('Fout bij initialiseren.');}finally{showLoading(false);}
}

// ---------------- RENDER MENU ----------------
function renderMenu(){
hideAll();
$('menuTitle').textContent=`Wat wil je dat ${chipOwner} voor je haalt?`;
const div=$('drinks');div.innerHTML='';
const frag=document.createDocumentFragment();
for(const d of drinks){
const btn=document.createElement('button');
btn.type='button';
btn.className='tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
btn.innerHTML=`<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">â‚¬${Number(d.price).toFixed(2)}</div>`;
btn.onclick=()=>{placeOrder(d); confettiBurst();};
frag.appendChild(btn);
}
div.appendChild(frag);
$('menu').classList.remove('hidden');
}

// ---------------- MORE FUNCTIONS ----------------
// (addCustomDrink, placeOrder, showScores, showBestellijst, showFinal, markMyPaid, backToMenu, polling etc.)
// Je kunt hier exact de vorige functies van het script plaatsen, maar met confettiBurst() bij nieuw rondje en drankje-knop.

// ---------------- EVENT LISTENERS ----------------
window.addEventListener('DOMContentLoaded',init);
$('addDrinkBtn').onclick=addCustomDrink;
$('bestelOverzichtBtn').onclick=showBestellijst;
$('scoresBtn').onclick=showScores;
$('finalBtn').onclick=showFinal;
$('newRoundBtn').onclick={()=>{renderMenu(); confettiBurst();}};
$('confirmScoresBtn').onclick=showScores;
$('backToMenuFromScores').onclick=backToMenu;
$('backToMenuFromBestel').onclick=backToMenu;
$('backToMenuFromFinal').onclick=backToMenu;
$('markPaidBtn').onclick=markMyPaid;
$('firstTimeContinueBtn').onclick=renderMenu;
</script>
</body>
</html>
