<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NextDrink NFC ‚Äî Tailwind</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    button { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-purple-100 to-orange-50 flex items-start justify-center p-6">
  <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="text-center text-white">
      <div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
      <div id="loadingText" class="mt-3">Bezig met laden...</div>
    </div>
  </div>

  <main class="w-full max-w-md bg-white rounded-2xl shadow-lg p-5">
    <header class="flex items-center gap-3">
      <img id="logo" src="images/nextdrink-logo.png" alt="NextDrink" class="w-12 h-12 rounded-lg object-cover"/>
      <div>
        <h1 class="text-lg font-semibold">NextDrink</h1>
        <p id="menuSubtitle" class="text-sm text-gray-500">Laad een NFC-sticker en kies een drankje</p>
      </div>
    </header>

    <!-- MENU -->
    <section id="menu" class="mt-4 hidden">
      <h2 id="menuTitle" class="text-sm font-semibold text-gray-700 mb-2"></h2>
      <div id="drinks" class="grid grid-cols-2 gap-3"></div>
      <div class="mt-4 grid grid-cols-1 gap-3">
        <button id="addDrinkBtn" class="w-full py-3 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700">+ Drankje toevoegen</button>
        <button id="bestelOverzichtBtn" class="w-full py-3 rounded-lg bg-emerald-500 text-white text-sm font-semibold">üìù Bekijk bestellijst</button>
        <div class="flex gap-3">
          <button id="scoresBtn" class="flex-1 py-3 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700">üìä Tussenstand</button>
          <button id="finalBtn" class="flex-1 py-3 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700">üèÅ Eindafrekening</button>
        </div>
      </div>
    </section>

    <!-- FIRST TIME -->
    <section id="firstTime" class="mt-4 hidden text-center">
      <h3 id="firstTimeTitle" class="text-lg font-semibold"></h3>
      <p id="firstTimeText" class="text-gray-600 mt-2"></p>
      <input id="firstTimeInput" type="text" placeholder="" class="mt-3 w-full px-3 py-2 border rounded-lg"/>
      <div class="mt-3">
        <button id="firstTimeContinueBtn" class="w-full py-3 rounded-lg bg-purple-600 text-white font-semibold">Verder</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="mt-4 hidden text-center">
      <div class="text-4xl">‚úÖ</div>
      <div id="confirmText" class="mt-3 font-semibold text-gray-700"></div>
      <div class="mt-4 flex gap-3">
        <button class="flex-1 py-3 rounded-lg bg-purple-600 text-white font-semibold" id="newRoundBtn">Nieuw rondje</button>
        <button class="flex-1 py-3 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700" id="confirmScoresBtn">Tussenstand</button>
      </div>
    </section>

    <!-- SCORES -->
    <section id="scores" class="mt-4 hidden">
      <h3 class="text-sm font-semibold text-gray-700">Tussenstand</h3>
      <div id="scoreList" class="mt-2 text-sm text-gray-700"></div>
      <div class="mt-4">
        <button class="w-full py-3 rounded-lg border border-gray-200 text-gray-700" id="backToMenuFromScores">Terug</button>
      </div>
    </section>

    <!-- BESTELLIJST -->
    <section id="bestellijst" class="mt-4 hidden">
      <h3 class="text-sm font-semibold text-gray-700">üìù Bestellijst</h3>
      <div id="bestellijstContent" class="mt-2 text-sm text-gray-700"></div>
      <div class="mt-4">
        <button class="w-full py-3 rounded-lg border border-gray-200 text-gray-700" id="backToMenuFromBestel">Terug</button>
      </div>
    </section>

    <!-- FINAL -->
    <section id="final" class="mt-4 hidden">
      <h3 class="text-sm font-semibold text-gray-700">üèÅ Eindafrekening</h3>
      <div id="finalTotals" class="mt-2 text-sm text-gray-700"></div>
      <div id="finalSettlements" class="mt-2 text-sm text-gray-700"></div>
      <div id="finalSettlementStatus" class="mt-2 text-sm text-gray-700"></div>
      <div class="mt-4 flex gap-2">
        <button class="flex-1 py-3 rounded-lg border border-gray-200 text-gray-700" id="markPaidBtn">Ik wil afrekenen</button>
        <button class="flex-1 py-3 rounded-lg border border-gray-200 text-gray-700" id="backToMenuFromFinal">Terug</button>
      </div>
    </section>

  </main>

  <script>
    const apiUrl="https://script.google.com/macros/s/AKfycbwW8-QL2zxIBhyy5NQGvmnhbX3Tm0cr7_71JJMfwy1Cad0jWCYyWyt18Qkny9gpksZG4w/exec";
    const $=id=>document.getElementById(id);
    const cacheTTL=30000;

    let chipId=new URLSearchParams(window.location.search).get('chipId');
    if(!chipId){ alert('Geen chipId in URL!'); throw new Error('Geen chipId'); }

    let scannerName=localStorage.getItem('scannerName')||'';
    let chipOwner='';
    let drinks=[];
    let settlementPollInterval=null;

    const showLoading=(show,text='Bezig...')=>{
      $('loadingText').textContent=text;
      $('loadingOverlay').style.display=show?'flex':'none';
      document.querySelectorAll('button').forEach(b=>b.disabled=show);
    };

    const hideAll=()=>{['menu','confirm','scores','final','firstTime','bestellijst'].forEach(id=>{const el=$(id);if(el) el.classList.add('hidden');});};
    const escapeHtml=str=>String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    async function init(){
      showLoading(true,'Initialiseren...');
      try{
        const ownerRes=await fetch(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
        chipOwner=(await ownerRes.text()).trim();
        const drinksRes=await fetch(`${apiUrl}?action=getDrinks`);
        drinks=await drinksRes.json();
        if(!drinks || !drinks.length) drinks=[{name:'Kleine bier',price:4.4},{name:'Grote bier',price:8},{name:'Desperados',price:6.5},{name:'Wijn',price:6},{name:'0.0 bier',price:4},{name:'Frisdrank',price:4}];

        hideAll();
        const input=$('firstTimeInput');
        $('firstTime').classList.remove('hidden');

        if(!scannerName && !chipOwner){
          $('firstTimeTitle').textContent='Welkom!';
          $('firstTimeText').textContent='Wat is je naam?';
          input.placeholder='Jouw naam';
          input.value='';
          input.dataset.mode='bothUnknown';
        } else if(scannerName && !chipOwner){
          $('firstTimeTitle').textContent='Chip onbekend';
          $('firstTimeText').textContent='Wiens chip heb je gescand?';
          input.placeholder='Naam sticker-eigenaar';
          input.value='';
          input.dataset.mode='chipUnknown';
        } else if(!scannerName && chipOwner){
          $('firstTimeTitle').textContent='Scanner onbekend';
          $('firstTimeText').textContent=`Je hebt de chip van ${chipOwner} gescand. Wat is jouw eigen naam?`;
          input.placeholder='Jouw naam';
          input.value='';
          input.dataset.mode='scannerUnknown';
        } else {
          renderMenu();
        }

      }catch(err){ console.error(err); alert('Fout bij initialiseren.'); }
      finally{ showLoading(false); }
    }

    $('firstTimeContinueBtn').addEventListener('click',async()=>{
      const val=$('firstTimeInput').value.trim();
      const mode=$('firstTimeInput').dataset.mode;
      if(!val){ alert('Vul een naam in'); return; }

      if(mode==='bothUnknown'){
        scannerName=val;
        chipOwner=val;
        localStorage.setItem('scannerName',scannerName);
        $('firstTimeTitle').textContent='Hoi '+val+'!';
        $('firstTimeText').innerHTML='Je naam is correct opgeslagen.<br/>Haal nu de QR code van de sticker af en plak de sticker onderin op de achterkant van je telefoon.';
        $('firstTimeInput').classList.add('hidden');
        $('firstTimeContinueBtn').textContent='Verder';
        $('firstTimeContinueBtn').onclick=renderMenu;
        try{ await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})}); }
        catch(e){ console.warn('Kon chipOwner niet opslaan',e); }
      } else if(mode==='scannerUnknown'){
        scannerName=val;
        localStorage.setItem('scannerName',scannerName);
        renderMenu();
      } else if(mode==='chipUnknown'){
        chipOwner=val;
        try{ await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})}); }
        catch(e){ console.warn('Kon chipOwner niet opslaan',e); }
        renderMenu();
      }
    });

    function renderMenu(){
      hideAll();
      $('menuTitle').textContent=`Wat wil je dat ${chipOwner} voor je haalt?`;
      const div=$('drinks'); div.innerHTML='';
      drinks.forEach(d=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
        btn.innerHTML=`<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">‚Ç¨${Number(d.price).toFixed(2)}</div>`;
        btn.onclick=()=>placeOrder(d);
        div.appendChild(btn);
      });
      $('menu').classList.remove('hidden');
    }

    async function placeOrder(drink){
      showLoading(true,'Verwerken...');
      try{
        await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'addScan',chipId,scanner:scannerName,drink:drink.name,amount:drink.price})});
        hideAll();
        $('confirmText').innerHTML=`${escapeHtml(drink.name)} (‚Ç¨${Number(drink.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner)}.`;
        $('confirm').classList.remove('hidden');
      }catch(err){ console.error(err); alert('Fout bij plaatsen order.'); }
      finally{ showLoading(false); }
    }

    async function fetchWithTimeout(url,options={},timeout=5000){
      const controller=new AbortController();
      const id=setTimeout(()=>controller.abort(),timeout);
      try{ const res=await fetch(url,{...options,signal:controller.signal}); clearTimeout(id); return res; } catch(e){ clearTimeout(id); throw e; }
    }

    async function addCustomDrink(){ const name=prompt('Naam van het nieuwe drankje?'); if(!name) return; const priceStr=prompt(`Prijs van "${name}"? (‚Ç¨)`); if(!priceStr) return; const price=parseFloat(priceStr.replace(',','.')); if(isNaN(price)||price<=0) return alert('Ongeldige prijs!'); drinks.push({name:name.trim(),price}); renderMenu(); }

    async function showBestellijst(){
      showLoading(true,'Bestellijst laden...');
      try{
        const resp=await fetchWithTimeout(`${apiUrl}?action=getScans`);
        const scans=await resp.json();
        const now=Date.now(); const FIFTEEN_MIN=15*60*1000;
        const recent=scans.filter(s=>s.owner===chipOwner && (now-new Date(s.timestamp).getTime()<=FIFTEEN_MIN));
        const grouped={};
        recent.forEach(s=>{ if(!grouped[s.scanner]) grouped[s.scanner]={}; grouped[s.scanner][s.drink]=(grouped[s.scanner][s.drink]||0)+1; });
        let html=`<p class="font-semibold">${escapeHtml(chipOwner)}</p>`;
        for(const [scanner,drinksObj] of Object.entries(grouped)){
          html+=`<p class="mt-2 font-semibold">${escapeHtml(scanner)}</p><ul class="list-disc ml-5">`;
          for(const [drinkName,count] of Object.entries(drinksObj)) html+=`<li>${count} √ó ${escapeHtml(drinkName)}</li>`;
          html+='</ul>';
        }
        html+='<p class="mt-3 font-semibold">En vergeet natuurlijk niet je eigen drankje!</p>';
        hideAll(); $('bestellijstContent').innerHTML=html; $('bestellijst').classList.remove('hidden');
      }catch(err){ console.error(err); alert('Fout bij laden bestellijst.'); }
      finally{ showLoading(false); }
    }

    async function showScores(){
      showLoading(true,'Tussenstand laden...');
      try{
        const resp=await fetchWithTimeout(`${apiUrl}?action=getScans`);
        const scans=await resp.json();
        const FIFTEEN_MIN=15*60*1000;
        const roundsByOwner={};
        scans.forEach(s=>{ const owner=s.owner; const ts=new Date(s.timestamp).getTime(); if(!roundsByOwner[owner]) roundsByOwner[owner]=[]; roundsByOwner[owner].push(ts); });
        const results=[];
        for(const [owner,times] of Object.entries(roundsByOwner)){
          const sorted=times.sort((a,b)=>a-b); let rounds=0; let last=-Infinity;
          for(const t of sorted){ if(t-last>FIFTEEN_MIN){ rounds+=1; last=t; } else last=Math.max(last,t); }
          results.push({owner,rounds});
        }
        results.sort((a,b)=>b.rounds-a.rounds);
        let html='<ul class="list-disc ml-5">';
        if(results.length===0) html+='<li>Nog geen data</li>'; else results.forEach(r=>{ html+=`<li><strong>${escapeHtml(r.owner)}</strong> ‚Äî ${r.rounds} rondje${r.rounds===1?'':'s'}</li>`; });
        html+='</ul>';
        hideAll(); $('scoreList').innerHTML=html; $('scores').classList.remove('hidden');
      }catch(err){ console.error(err); alert('Fout bij laden tussenstand.'); }
      finally{ showLoading(false); }
    }

    async function showFinal(){
      showLoading(true,'Eindafrekening laden...');
      try{
        const resp=await fetchWithTimeout(`${apiUrl}?action=getFinal`);
        const finalData=await resp.json();
        const totals=finalData.result||[];
        const settlements=finalData.settlements||[];
        let htmlTotals=''; let htmlSettle='';
        if(!totals.length) htmlTotals='<p>Nog geen data</p>'; else { totals.sort((a,b)=>Number(b.balance)-Number(a.balance)); htmlTotals+='<div class="font-semibold mb-2">Totaal uitgegeven per persoon:</div><ul class="list-disc ml-5">'; totals.forEach(t=>{ htmlTotals+=`<li><strong>${escapeHtml(t.name)}</strong> ‚Äî ‚Ç¨${Number(t.balance).toFixed(2)} (${Number(t.balance)>=0?'positief':'negatief'})</li>`; }); htmlTotals+='</ul>'; }
        if(!settlements.length) htmlSettle='<p>Geen verrekeningen nodig.</p>'; else { htmlSettle+='<div class="font-semibold mt-2">Verrekeningen</div><ul class="list-disc ml-5">'; settlements.forEach(s=>{ htmlSettle+=`<li>${escapeHtml(s.from)} betaalt ‚Ç¨${Number(s.amount).toFixed(2)} aan ${escapeHtml(s.to)}</li>`; }); htmlSettle+='</ul>'; }
        hideAll(); $('finalTotals').innerHTML=htmlTotals; $('finalSettlements').innerHTML=htmlSettle; $('finalSettlementStatus').innerHTML=''; $('final').classList.remove('hidden');
      }catch(err){ console.error(err); alert('Fout bij laden eindafrekening.'); }
      finally{ showLoading(false); }
    }

    async function markMyPaid(){ showLoading(true,'Bezig met bevestigen...'); try{ await fetchWithTimeout(apiUrl,{method:'POST',body:new URLSearchParams({action:'markPaid',owner:scannerName,chipId})}); alert('Betaald gemarkeerd'); renderMenu(); }catch(e){ console.error(e); alert('Kon betaling niet bevestigen'); } finally{ showLoading(false); } }

    window.addEventListener('DOMContentLoaded',()=>{
      init();
      $('addDrinkBtn').addEventListener('click',addCustomDrink);
      $('bestelOverzichtBtn').addEventListener('click',showBestellijst);
      $('scoresBtn').addEventListener('click',showScores);
      $('finalBtn').addEventListener('click',showFinal);
      $('newRoundBtn').addEventListener('click',renderMenu);
      $('confirmScoresBtn').addEventListener('click',showScores);
      $('backToMenuFromScores').addEventListener('click',renderMenu);
      $('backToMenuFromBestel').addEventListener('click',renderMenu);
      $('backToMenuFromFinal').addEventListener('click',renderMenu);
      $('markPaidBtn').addEventListener('click',markMyPaid);
    });
  </script>
</body>
</html>
