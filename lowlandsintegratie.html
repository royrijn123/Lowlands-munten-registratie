<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lowlands x NextDrink</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* =========================
     DESIGN SYSTEM VARIABELEN
     ========================= */
  :root{
    /* Paarse tint uit NextDrink-logo (pas hier 1-op-1 aan indien nodig) */
    --nd-purple: #4B008F;
    --nd-purple-weak: rgba(75, 0, 143, 0.08);
    --card-bg: rgba(255,255,255,0.85); /* ~15% transparant */
    --card-border: rgba(255,255,255,0.35);
    --glow: rgba(75,0,143,0.45);
    --overlay: rgba(75,0,143,0.12); /* paarse mist over bg */
  }

  /* ========== FONTS ========== */
  @font-face{
    font-family: 'Baukasten';
    src: url('fonts/Baukasten%20Six%20Regular.otf') format('opentype');
    font-display: swap;
  }

  /* ========== BASIS ========== */
  html, body { height: 100%; }
  body{
    font-family: 'Poppins', sans-serif;
    color: #1f1140;
    background-image: url('images/lowlands2025-bg.PNG');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    position: relative;
  }
  /* Paarse overlay voor contrast in zon en zalen */
  body::before{
    content:"";
    position: fixed; inset: 0;
    background: linear-gradient(180deg, var(--overlay), transparent 30%, var(--overlay) 70%, transparent);
    pointer-events: none;
    z-index: 0;
  }

  /* Kaarten in glassmorphism-stijl */
  main{
    position: relative;
    z-index: 1;
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    box-shadow:
      0 10px 30px rgba(0,0,0,0.15),
      0 1px 0 rgba(255,255,255,0.35) inset;
  }

  /* Lowlands/Apple-achtige headings & knoppen: BAUKASTEN + HOOFDLETTERS */
  .nd-heading, h1, h2, h3,
  .nd-btn, .logo-x {
    font-family: 'Baukasten', system-ui, sans-serif !important;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--nd-purple);
  }

  /* Puur leeswerk in Poppins laten */
  p, li, input,
  #scoreList, #bestellijstContent, #finalTotals, #finalSettlements {
    font-family: 'Poppins', sans-serif;
  }

  /* Knoppen styling (Apple-ish + glow) */
  .nd-btn{
    position: relative;
    -webkit-tap-highlight-color: transparent;
    transition: transform .12s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
    box-shadow:
      0 0 0 rgba(0,0,0,0),
      0 1px 0 rgba(255,255,255,0.15) inset;
    border: 1px solid rgba(255,255,255,0.35);
  }
  .nd-btn:hover{ transform: translateY(-1px); }
  .nd-btn:active{ transform: translateY(0); }
  .nd-primary{
    background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45));
    color: var(--nd-purple);
  }
  .nd-primary:hover{
    box-shadow: 0 10px 28px var(--glow);
  }

/* Lichter paarse actieknoppen met witte tekst en subtiele glow */
.nd-cta {
  background: #7b57c5; /* iets lichter paars */
  color: #fff !important;
  border: none;
  box-shadow: 0 4px 12px rgba(75, 0, 143, 0.25);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25); /* subtiele leesbaarheid */
  transition: all 0.2s ease;
}

.nd-cta:hover {
  background: #6b45b4; /* iets donkerder bij hover */
  box-shadow: 0 8px 20px rgba(75, 0, 143, 0.35);
  transform: translateY(-1px);
}

.nd-cta:active {
  transform: translateY(0);
}

  /* Drank-tegeltjes */
  .tile{ transition: transform .1s ease, background-color .2s ease, box-shadow .2s ease; }
  .tile:hover{
    background: rgba(255,255,255,0.9);
    transform: scale(1.02);
    box-shadow: 0 8px 20px var(--nd-purple-weak);
  }

  /* X tussen logo‚Äôs (tekst, iets kleiner) */
  .logo-x{
    font-size: 24px; /* kleiner dan de logo's */
    line-height: 1;
    color: var(--nd-purple);
    transform: translateY(-1px);
  }

  /* Nummer input: geen pijltjes */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{ -webkit-appearance: none; margin: 0; }
  input[type=number]{ appearance: textfield; }

  /* Form velden consistent */
  .nd-input{
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #d1d5db;
    background: rgba(255,255,255,0.9);
  }

  /* Loading overlay */
  #loadingOverlay{
    background: rgba(10,10,20,0.55);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }

  /* Bestellijst panelen */
  .orders-wrap{
    display: grid;
    gap: 12px;
  }
  .order-panel{
    background: rgba(255,255,255,0.88);
    border: 1px solid var(--card-border);
    border-radius: 14px;
    padding: 12px 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  .order-panel h4{
    font-family: 'Baukasten', system-ui, sans-serif;
    text-transform: uppercase;
    color: var(--nd-purple);
    font-size: 0.9rem;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
  }
  .order-row{
    display: grid;
    grid-template-columns: 46px 1fr;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(0,0,0,0.08);
  }
  .order-row:last-child{ border-bottom: none; }
  .order-qty{
    font-family: 'Baukasten', system-ui, sans-serif;
    text-transform: uppercase;
    color: var(--nd-purple);
    font-size: 0.95rem;
    text-align: right;
  }
  .order-name{ color: #2d2352; }

  /* Utility */
  .text-lowlands{ color: var(--nd-purple); }
</style>
</head>

<body class="min-h-screen flex items-start justify-center p-6">

<main class="w-full max-w-md rounded-3xl shadow-2xl p-6">

  <!-- HEADER: NextDrink-logo √ó LL26-logo -->
  <header class="flex items-center justify-center gap-3 mb-5">
    <img src="images/logo-ll26.PNG" alt="LL26" class="w-12 h-12 rounded-lg object-cover"/>
    <span class="logo-x" aria-hidden="true">√ó</span>
    <img src="images/nextdrink-logo.png" alt="NextDrink" class="w-12 h-12 rounded-lg object-cover"/>
  </header>

  <!-- FIRST TIME / SET NAME -->
  <section id="firstTime" class="text-center hidden">
    <h3 class="nd-heading text-xl font-bold mb-2">Welkom!</h3>
    <p class="text-purple-800 mb-3">Voer je naam in om te starten:</p>
    <input id="firstTimeNameInput" type="text" placeholder="Jouw naam" class="nd-input mb-3">
    <button id="firstTimeContinueBtn" class="nd-btn nd-cta w-full py-3 rounded-xl font-bold">Verder</button>
  </section>

  <!-- POST-NAME INSTRUCTIONS -->
  <section id="postName" class="hidden text-center">
    <div class="text-5xl mb-2"></div>
    <h3 class="nd-heading text-lg font-semibold mb-2">Je bent klaar!</h3>
    <p class="text-purple-900">
      Haal de <strong>QR-code</strong> van je sticker en plak het andere deel <strong>onderin op de achterkant</strong> van je telefoon.
    </p>
    <button id="postNameContinueBtn" class="nd-btn nd-cta mt-4 w-full py-3 rounded-xl font-bold">Verder</button>
  </section>

  <!-- MENU -->
  <section id="menu" class="hidden">
    <h2 id="menuTitle" class="nd-heading text-lg font-semibold mb-3"></h2>
    <div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>
    <div class="grid grid-cols-1 gap-3">
      <button id="newDrinkScreenBtn" class="nd-btn nd-primary w-full py-3 rounded-xl font-semibold">+ Nieuw drankje</button>
      <button id="bestelOverzichtBtn" class="nd-btn nd-cta w-full py-3 rounded-xl font-bold text-white">Bekijk bestellijst</button>
      <div class="flex gap-3 mt-2">
        <button id="scoresBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Tussenstand</button>
        <button id="finalBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Eindafrekening</button>
      </div>
    </div>
  </section>

  <!-- NEW DRINK SCREEN -->
  <section id="newDrink" class="hidden">
    <h3 class="nd-heading font-bold mb-3">Nieuw drankje toevoegen</h3>
    <div class="flex flex-col gap-3 mb-3">
      <input id="newDrinkName" type="text" placeholder="Naam nieuw drankje" class="nd-input">
      <input id="newDrinkPrice" type="number" step="0.01" placeholder="Prijs (‚Ç¨)" class="nd-input">
    </div>
    <div class="flex gap-2">
      <button id="addDrinkBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Opslaan</button>
      <button id="cancelNewDrinkBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Annuleren</button>
    </div>
  </section>

  <!-- CONFIRM -->
  <section id="confirm" class="hidden text-center">
    <div class="text-5xl">‚úÖ</div>
    <div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
    <div class="mt-4 flex gap-3">
      <button id="newRoundBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Nieuw rondje</button>
      <button id="confirmScoresBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Tussenstand</button>
    </div>
  </section>

  <!-- SCORES -->
  <section id="scores" class="hidden">
    <h3 class="nd-heading font-bold mb-2">Tussenstand</h3>
    <div id="scoreList" class="text-purple-900"></div>
    <div class="mt-4">
      <button id="backToMenuFromScores" class="nd-btn nd-primary w-full py-3 rounded-xl font-bold">Terug</button>
    </div>
  </section>

  <!-- BESTELLIJST -->
  <section id="bestellijst" class="hidden">
    <h3 class="nd-heading font-bold mb-2">üìù Bestellijst (laatste 30 min)</h3>
    <div id="bestellijstContent" class="orders-wrap"></div>
    <div class="mt-4">
      <button id="backToMenuFromBestel" class="nd-btn nd-primary w-full py-3 rounded-xl font-bold">Terug</button>
    </div>
  </section>

  <!-- FINAL -->
  <section id="final" class="hidden">
    <h3 class="nd-heading font-bold mb-2">üèÅ Eindafrekening</h3>
    <div id="finalTotals" class="text-purple-900"></div>
    <div id="finalSettlements" class="text-purple-900 mt-2"></div>
    <div id="finalSettlementStatus" class="text-purple-900 mt-2"></div>
    <div class="mt-4 flex gap-2">
      <button id="markPaidBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Ik wil afrekenen üí∏</button>
      <button id="backToMenuFromFinal" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Terug</button>
    </div>
  </section>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="text-center text-white">
      <div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
      <div id="loadingText" class="mt-3">Bezig met laden...</div>
    </div>
  </div>

</main>

<script>
  const $ = id => document.getElementById(id);
  const apiUrl = "https://script.google.com/macros/s/AKfycbwW8-QL2zxIBhyy5NQGvmnhbX3Tm0cr7_71JJMfwy1Cad0jWCYyWyt18Qkny9gpksZG4w/exec";
  const chipId = new URLSearchParams(window.location.search).get('chipId');
  if (!chipId) { alert('Geen chipId in URL!'); throw new Error('Geen chipId'); }

  let scannerName = localStorage.getItem('scannerName') || '';
  let chipOwner = '';
  let drinks = [];

  function showLoading(show, text='Bezig...') {
    $('loadingOverlay').style.display = show ? 'flex' : 'none';
    $('loadingText').textContent = text;
    document.querySelectorAll('button').forEach(b => b.disabled = show);
  }
  async function fetchWithTimeout(url, options={}, timeout=8000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const res = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(id);
      return res;
    } catch (err) {
      clearTimeout(id);
      throw err;
    }
  }
  function hideAll() {
    ['menu','confirm','scores','final','firstTime','bestellijst','newDrink','postName']
      .forEach(id => $(id)?.classList.add('hidden'));
  }
  function escapeHtml(str){
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ---------- INIT ----------
  async function init(){
    showLoading(true,'Initialiseren...');
    try{
      const ownerResp = await fetchWithTimeout(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
      chipOwner = (await ownerResp.text()).trim();

      const drinksResp = await fetchWithTimeout(`${apiUrl}?action=getDrinks`);
      drinks = await drinksResp.json();
      if(!drinks?.length) drinks = [
        {name:'Kleine bier',price:4.4},{name:'Grote bier',price:8},
        {name:'Desperados',price:6.5},{name:'Wijn',price:6},
        {name:'0.0 bier',price:4},{name:'Frisdrank',price:4}
      ];

      if(!scannerName && !chipOwner){
        hideAll(); $('firstTime').classList.remove('hidden'); return;
      }
      renderMenu();
    }catch(err){ console.error(err); alert('Fout bij initialiseren.'); }
    finally{ showLoading(false); }
  }

  // ---------- FIRST TIME CONTINUE ----------
  $('firstTimeContinueBtn').onclick = async ()=>{
    const name = $('firstTimeNameInput').value.trim();
    if(!name){ alert('Voer een naam in'); return; }
    showLoading(true,'Verwerken...');
    scannerName = chipOwner = name;
    localStorage.setItem('scannerName', scannerName);
    try{
      await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'setOwner', chipId, owner:chipOwner}) });
      hideAll(); $('postName').classList.remove('hidden');
    }catch(e){ console.warn(e); renderMenu(); }
    finally{ showLoading(false); }
  };
  $('postNameContinueBtn').onclick = ()=>{ renderMenu(); };

  // ---------- NEW DRINK SCREEN ----------
  $('newDrinkScreenBtn').onclick = ()=>{ hideAll(); $('newDrink').classList.remove('hidden'); };
  $('cancelNewDrinkBtn').onclick = ()=>{ renderMenu(); };
  $('addDrinkBtn').onclick = async ()=>{
    const name = $('newDrinkName').value.trim();
    const price = parseFloat($('newDrinkPrice').value);
    if(!name || isNaN(price) || price<=0){ alert('Ongeldige naam of prijs'); return; }
    showLoading(true,'Opslaan...');
    drinks.push({name, price});
    $('newDrinkName').value=''; $('newDrinkPrice').value='';
    try{
      await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'setDrinks', drinks:JSON.stringify(drinks)}) });
      renderMenu();
    }catch(e){ console.error(e); alert('Fout bij opslaan drankje'); }
    finally{ showLoading(false); }
  };

  // ---------- MENU ----------
  function renderMenu(){
    hideAll();
    const title = chipOwner ? `WAT WIL JE DAT ${chipOwner.toUpperCase()} VOOR JE HAALT?` : 'KIES JE DRANKJE';
    const titleEl = $('menuTitle');
    titleEl.textContent = title;
    const div = $('drinks'); div.innerHTML='';
    drinks.forEach(d=>{
      const btn = document.createElement('button');
      btn.className = 'tile block w-full rounded-lg p-3 bg-white/90 shadow-sm ring-1 ring-white/60 text-left';
      btn.innerHTML = `
        <div class="font-semibold text-gray-900">${escapeHtml(d.name)}</div>
        <div class="text-sm text-gray-600 mt-1">‚Ç¨${Number(d.price).toFixed(2)}</div>
      `;
      btn.onclick = async ()=>{
        showLoading(true,'Verwerken...');
        try{
          await fetch(apiUrl, { method:'POST',
            body:new URLSearchParams({action:'addScan', chipId, scanner:scannerName, drink:d.name, amount:d.price}) });
          $('confirmText').innerHTML = `${escapeHtml(d.name)} (‚Ç¨${Number(d.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner)}.`;
          hideAll(); $('confirm').classList.remove('hidden');
        }catch(e){ console.error(e); alert('Fout bij plaatsen order'); }
        finally{ showLoading(false); }
      };
      div.appendChild(btn);
    });
    $('menu').classList.remove('hidden');
  }

  // ---------- BESTELLIJST (laatste 30 min) ----------
  $('bestelOverzichtBtn').onclick = async ()=>{
    showLoading(true,'Bestellijst laden...');
    try{
      const res = await fetch(`${apiUrl}?action=getScans`);
      const scans = await res.json();
      const now = Date.now();
      const THIRTY_MIN = 30*60*1000;

      const recent = scans.filter(s=>{
        if(s.owner !== chipOwner) return false;
        const t = new Date(s.timestamp || s.time || s.date || 0).getTime();
        return isFinite(t) ? (now - t) <= THIRTY_MIN : false;
      });

      // Groeperen per scanner en drank
      const grouped = {};
      recent.forEach(s=>{
        if(!grouped[s.scanner]) grouped[s.scanner] = {};
        grouped[s.scanner][s.drink] = (grouped[s.scanner][s.drink] || 0) + 1;
      });

      // HTML opbouw in Apple-achtige panelen
      let html = '';
      if(recent.length===0){
        html = `<div class="order-panel"><p>Geen recente bestellingen (laatste 30 minuten) voor <strong>${escapeHtml(chipOwner)}</strong>.</p></div>`;
      }else{
        Object.entries(grouped).forEach(([scanner, drinksObj])=>{
          html += `<div class="order-panel">
            <h4>${escapeHtml(scanner)}</h4>
            <div>`;
          Object.entries(drinksObj).forEach(([drinkName, count])=>{
            html += `<div class="order-row">
              <div class="order-qty">${count}√ó</div>
              <div class="order-name">${escapeHtml(drinkName)}</div>
            </div>`;
          });
          html += `</div></div>`;
        });
      }

      hideAll(); $('bestellijstContent').innerHTML = html; $('bestellijst').classList.remove('hidden');
    }catch(e){ console.error(e); alert('Fout bij laden bestellijst'); }
    finally{ showLoading(false); }
  };
  $('backToMenuFromBestel').onclick = renderMenu;

  // ---------- SCORES ----------
  $('backToMenuFromScores').onclick = renderMenu;
  $('newRoundBtn').onclick = renderMenu;
  $('confirmScoresBtn').onclick = async ()=>{ await showScores(); };
  $('scoresBtn').onclick = async ()=>{ await showScores(); };

  async function showScores(){
    showLoading(true,'Tussenstand laden...');
    try{
      const res = await fetch(`${apiUrl}?action=getScores`);
      const scores = await res.json();
      let html = '<ul class="list-disc ml-5">';
      if(!scores.length) html += '<li>Nog geen data</li>';
      else scores.forEach(s=>{
        html += `<li><strong>${escapeHtml(s.owner)}</strong> ‚Äî ${s.rounds} rondje${s.rounds===1?'':'s'}</li>`;
      });
      html += '</ul>';
      hideAll(); $('scoreList').innerHTML = html; $('scores').classList.remove('hidden');
    }catch(e){ console.error(e); alert('Fout bij laden tussenstand'); }
    finally{ showLoading(false); }
  }

  // ---------- FINAL ----------
  $('finalBtn').onclick = async ()=>{ await showFinal(); };
  $('backToMenuFromFinal').onclick = renderMenu;
  $('markPaidBtn').onclick = async ()=>{
    showLoading(true,'Bezig met registreren...');
    try{
      await fetch(apiUrl, { method:'POST', body:new URLSearchParams({action:'markAsPaid', name:scannerName}) });
      $('finalSettlementStatus').textContent = '‚úÖ Betaald geregistreerd!';
    }catch(e){ console.error(e); alert('Fout bij afrekenen'); }
    finally{ showLoading(false); }
  };

  async function showFinal(){
    showLoading(true,'Eindafrekening laden...');
    try{
      const res = await fetch(`${apiUrl}?action=getFinal`);
      const data = await res.json();
      let htmlTotals = '';
      if(!data.result?.length) htmlTotals = '<p>Nog geen data</p>';
      else{
        htmlTotals += '<div class="font-semibold mb-2">Totaal uitgegeven per persoon:</div><ul class="list-disc ml-5">';
        data.result.forEach(t=>{
          htmlTotals += `<li><strong>${escapeHtml(t.name)}</strong> ‚Äî ‚Ç¨${Number(t.balance).toFixed(2)}</li>`;
        });
        htmlTotals += '</ul>';
      }
      let htmlSettle = '';
      if(!data.settlements?.length) htmlSettle = '<p>Geen verrekeningen nodig.</p>';
      else{
        htmlSettle += '<div class="font-semibold mt-2">Verrekeningen</div><ul class="list-disc ml-5">';
        data.settlements.forEach(s=>{
          htmlSettle += `<li>${escapeHtml(s.from)} betaalt ‚Ç¨${Number(s.amount).toFixed(2)} aan ${escapeHtml(s.to)}</li>`;
        });
        htmlSettle += '</ul>';
      }
      hideAll(); $('finalTotals').innerHTML = htmlTotals; $('finalSettlements').innerHTML = htmlSettle; $('final').classList.remove('hidden');
    }catch(e){ console.error(e); alert('Fout bij laden eindafrekening'); }
    finally{ showLoading(false); }
  }

  // ---------- START ----------
  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
