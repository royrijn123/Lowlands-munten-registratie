<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NextDrink NFC â€” Lowlands Style</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
button{ -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
button:hover{ transform: scale(1.03); }
.tile:hover{ background: #fef3c7; transform: scale(1.02); }
body{ font-family: 'Poppins', sans-serif; }
</style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-300 via-pink-200 to-orange-200 flex items-start justify-center p-6">

<main class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6">

<header class="flex items-center gap-3 mb-5">
<img id="logo" src="images/nextdrink-logo.png" alt="NextDrink" class="w-14 h-14 rounded-lg object-cover"/>
<div>
<h1 class="text-2xl font-bold text-purple-700">NextDrink</h1>
<p id="menuSubtitle" class="text-sm text-purple-800">Laad je NFC-sticker en kies je drankje ğŸ¹</p>
</div>
</header>

<!-- MENU -->
<section id="menu" class="hidden">
<h2 id="menuTitle" class="text-lg font-semibold text-purple-700 mb-3"></h2>
<div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>

<div class="grid grid-cols-1 gap-3">
<button id="addDrinkBtn" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-800 font-semibold shadow hover:bg-yellow-300">+ Drankje toevoegen</button>
<button id="bestelOverzichtBtn" class="w-full py-3 rounded-xl bg-green-400 text-white font-bold shadow hover:bg-green-300">ğŸ“ Bekijk bestellijst</button>
<div class="flex gap-3 mt-2">
<button id="scoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold shadow hover:bg-pink-300">ğŸ“Š Tussenstand</button>
<button id="finalBtn" class="flex-1 py-3 rounded-xl bg-purple-500 text-white font-bold shadow hover:bg-purple-400">ğŸ Eindafrekening</button>
</div>
</div>
</section>

<!-- FIRST TIME -->
<section id="firstTime" class="hidden text-center">
<h3 id="firstTimeTitle" class="text-xl font-bold text-purple-700 mb-2"></h3>
<p id="firstTimeText" class="text-purple-800 mb-3"></p>
<div class="mt-3">
<button id="firstTimeContinueBtn" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Verder</button>
</div>
</section>

<!-- CONFIRM -->
<section id="confirm" class="hidden text-center">
<div class="text-5xl">âœ…</div>
<div id="confirmText" class="mt-3 font-semibold text-purple-700"></div>
<div class="mt-4 flex gap-3">
<button id="newRoundBtn" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500">Nieuw rondje ğŸ‰</button>
<button id="confirmScoresBtn" class="flex-1 py-3 rounded-xl bg-pink-400 text-white font-bold hover:bg-pink-300">Tussenstand ğŸ“Š</button>
</div>
</section>

<!-- SCORES -->
<section id="scores" class="hidden">
<h3 class="text-purple-700 font-bold mb-2">Tussenstand</h3>
<div id="scoreList" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromScores" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- BESTELLIJST -->
<section id="bestellijst" class="hidden">
<h3 class="text-purple-700 font-bold mb-2">ğŸ“ Bestellijst</h3>
<div id="bestellijstContent" class="text-purple-800"></div>
<div class="mt-4">
<button id="backToMenuFromBestel" class="w-full py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

<!-- FINAL -->
<section id="final" class="hidden">
<h3 class="text-purple-700 font-bold mb-2">ğŸ Eindafrekening</h3>
<div id="finalTotals" class="text-purple-800"></div>
<div id="finalSettlements" class="text-purple-800 mt-2"></div>
<div id="finalSettlementStatus" class="text-purple-800 mt-2"></div>
<div class="mt-4 flex gap-2">
<button id="markPaidBtn" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-400">Ik wil afrekenen ğŸ’¸</button>
<button id="backToMenuFromFinal" class="flex-1 py-3 rounded-xl bg-yellow-400 text-purple-700 font-bold hover:bg-yellow-300">Terug</button>
</div>
</section>

</main>

<script>
const $ = id=>document.getElementById(id);
const apiUrl = "https://script.google.com/macros/s/AKfycbwW8-QL2zxIBhyy5NQGvmnhbX3Tm0cr7_71JJMfwy1Cad0jWCYyWyt18Qkny9gpksZG4w/exec";
const cacheTTL = 30000;
let chipId = new URLSearchParams(window.location.search).get('chipId');
if(!chipId){ alert('Geen chipId in URL!'); throw new Error('Geen chipId'); }

let scannerName = localStorage.getItem('scannerName') || '';
let chipOwner = '';
let drinks = [];
let settlementPollInterval = null;

const showLoading = (show,text='Bezig...')=>{
  document.querySelectorAll('button').forEach(b=>b.disabled=show);
};

const fetchWithTimeout = async(url,options={},timeout=5000)=>{
  const controller=new AbortController();
  const id=setTimeout(()=>controller.abort(),timeout);
  try{
    const res = await fetch(url,{...options,signal:controller.signal});
    clearTimeout(id);
    return res;
  }catch(err){
    clearTimeout(id);
    throw err;
  }
};

const cacheGet=key=>{
  try{
    const raw = sessionStorage.getItem(key);
    if(!raw) return null;
    const {data,time}=JSON.parse(raw);
    if(Date.now()-time>cacheTTL) return null;
    return data;
  }catch(e){return null;}
};
const cacheSet=(key,data)=>{try{sessionStorage.setItem(key,JSON.stringify({data,time:Date.now()}));}catch(e){}};

function hideAll(){ ['menu','confirm','scores','final','firstTime','bestellijst'].forEach(id=>{ const el=$(id); if(el) el.classList.add('hidden'); }); }

function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function init(){
  // fetch drinks & chipOwner
  try{
    const ownerResp = await fetchWithTimeout(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
    chipOwner = (await ownerResp.text()).trim();
    const drinksResp = await fetchWithTimeout(`${apiUrl}?action=getDrinks`);
    drinks = await drinksResp.json();
    if(!drinks || !drinks.length){
      drinks = [
        {name:'Kleine bier',price:4.40},
        {name:'Grote bier',price:8.00},
        {name:'Desperados',price:6.50},
        {name:'Wijn',price:6.00},
        {name:'0.0 bier',price:4.00},
        {name:'Frisdrank',price:4.00}
      ];
    }

    // FIRST-TIME LOGIC
    if(!scannerName && !chipOwner){
      // beide onbekend
      $('firstTimeTitle').textContent = 'Welkom!';
      $('firstTimeText').innerHTML = 'Hoi! Je naam wordt eerst opgeslagen.';
      $('firstTime').classList.remove('hidden');
      $('firstTimeContinueBtn').onclick = ()=>{
        const name = prompt('Wat is je naam?')?.trim();
        if(!name){ alert('Geen naam ingevoerd.'); return; }
        scannerName = chipOwner = name;
        localStorage.setItem('scannerName',scannerName);
        fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})}).catch(console.warn);
        $('firstTimeText').innerHTML = `Hoi ${chipOwner}! Je naam is correct opgeslagen.<br/>Haal nu de QR code van de sticker af en plak de sticker onderin op de achterkant van je telefoon.`;
        $('firstTimeContinueBtn').onclick = renderMenu;
      };
      return;
    }

    if(chipOwner && !scannerName){
      // chip bekend, localStorage onbekend
      const name = prompt(`Je hebt de chip van ${chipOwner} gescand. Wat is jouw naam?`)?.trim();
      if(!name){ alert('Geen naam ingevoerd.'); return; }
      scannerName = name;
      localStorage.setItem('scannerName',scannerName);
    }

    if(scannerName && !chipOwner){
      // localStorage bekend, chip onbekend
      const ownerName = prompt('Wiens chip heb je gescand?')?.trim();
      if(!ownerName){ alert('Geen naam ingevoerd.'); return; }
      chipOwner = ownerName;
      fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setOwner',chipId,owner:chipOwner})}).catch(console.warn);
    }

    renderMenu();

  }catch(err){ console.error(err); alert('Fout bij initialiseren.'); }
}

function renderMenu(){
  hideAll();
  $('menuTitle').textContent = `Wat wil je dat ${chipOwner} voor je haalt?`;
  const div=$('drinks'); div.innerHTML='';
  const frag=document.createDocumentFragment();
  for(const d of drinks){
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='tile block w-full rounded-lg p-3 bg-white shadow-sm ring-1 ring-gray-100 text-left';
    btn.innerHTML = `<div class="font-semibold text-gray-800">${escapeHtml(d.name)}</div><div class="text-sm text-gray-500 mt-1">â‚¬${Number(d.price).toFixed(2)}</div>`;
    btn.onclick=()=>placeOrder(d);
    const wrapper=document.createElement('div'); wrapper.appendChild(btn); frag.appendChild(wrapper);
  }
  div.appendChild(frag);
  $('menu').classList.remove('hidden');
}

async function addCustomDrink(){
  const name = prompt('Naam van het nieuwe drankje?'); if(!name) return;
  const priceStr = prompt(`Prijs van "${name}"? (â‚¬)`); if(!priceStr) return;
  const price = parseFloat(String(priceStr).replace(',', '.'));
  if(isNaN(price) || price<=0) return alert('Ongeldige prijs!');
  drinks.push({name:name.trim(),price});
  try{ await fetch(apiUrl,{method:'POST',body:new URLSearchParams({action:'setDrinks',drinks:JSON.stringify(drinks)})}); }catch(e){ console.error(e);}
  renderMenu();
}

async function placeOrder(drink){
  try{
    await fetchWithTimeout(apiUrl,{method:'POST',body:new URLSearchParams({action:'addScan',chipId,scanner:scannerName,drink:drink.name,amount:drink.price})},6000);
    hideAll();
    $('confirmText').innerHTML = `${escapeHtml(drink.name)} (&euro;${Number(drink.price).toFixed(2)}) is doorgegeven aan ${escapeHtml(chipOwner)}.`;
    $('confirm').classList.remove('hidden');
  }catch(err){ console.error(err); alert('Fout bij plaatsen order.'); }
}

window.addEventListener('DOMContentLoaded',()=>{
  init();
  $('addDrinkBtn').addEventListener('click',addCustomDrink);
  $('bestelOverzichtBtn').addEventListener('click',()=>{ /* hier je showBestellijst functie */ });
  $('scoresBtn').addEventListener('click',()=>{ /* hier je showScores functie */ });
  $('finalBtn').addEventListener('click',()=>{ /* hier je showFinal functie */ });
  $('newRoundBtn').addEventListener('click',renderMenu);
  $('confirmScoresBtn').addEventListener('click',()=>{ /* hier showScores */ });
  $('backToMenuFromScores').addEventListener('click',renderMenu);
  $('backToMenuFromBestel').addEventListener('click',renderMenu);
  $('backToMenuFromFinal').addEventListener('click',renderMenu);
  $('markPaidBtn').addEventListener('click',()=>{ /* hier markMyPaid */ });
  $('firstTimeContinueBtn').addEventListener('click',renderMenu);
});
</script>
</body>
</html>
