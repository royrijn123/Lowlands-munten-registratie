<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lowlands x NextDrink</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --nd-purple: #4B008F;
      --nd-purple-weak: rgba(75, 0, 143, 0.08);
      --card-bg: rgba(255,255,255,0.88);
      --card-border: rgba(255,255,255,0.35);
      --glow: rgba(75,0,143,0.45);
      --overlay: rgba(75,0,143,0.12);
    }

    @font-face{
      font-family: 'Baukasten';
      src: url('fonts/Baukasten Six Regular.otf') format('opentype');
      font-display: swap;
    }

    html, body { height: 100%; }

    body{
      font-family: 'Poppins', sans-serif;
      color: #1f1140;
      background-image: url('images/lowlands2025-bg.PNG');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    body::before{
      content:"";
      position: fixed; inset: 0;
      background: linear-gradient(180deg, var(--overlay), transparent 30%, var(--overlay) 70%, transparent);
      pointer-events: none;
      z-index: 0;
    }

    main{
      position: relative;
      z-index: 1;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      box-shadow:
        0 10px 30px rgba(0,0,0,0.15),
        0 1px 0 rgba(255,255,255,0.35) inset;
    }

    .nd-heading,
    h1,h2,h3,
    .nd-btn,.logo-x {
      font-family: 'Baukasten', system-ui, sans-serif !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--nd-purple);
    }

    /* Header met logo's naast elkaar - helft kleiner */
    #headerRoot{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:1.2rem;
      margin-bottom:1.25rem;
    }
    #headerRoot img{
      border-radius:0.9rem;
      object-fit:cover;
      width:6rem;
      height:6rem;
    }
    #headerRoot .logo-x{
      font-size:2.4rem;
      line-height:1;
      color:var(--nd-purple);
    }

    /* Error banner */
    #errorBanner{
      transition: opacity .25s ease;
    }

    /* Buttons */
    .nd-btn{
      position: relative;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
      box-shadow:
        0 0 0 rgba(0,0,0,0),
        0 1px 0 rgba(255,255,255,0.15) inset;
      border: 1px solid rgba(255,255,255,0.35);
    }
    .nd-btn:hover{ transform: translateY(-1px); }
    .nd-btn:active{ transform: translateY(0); }

    .nd-primary{
      background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45));
      color: var(--nd-purple);
    }

    .nd-cta{
      background: #a68af0;
      color: #fff !important;
      border: none;
      box-shadow: 0 4px 10px rgba(120, 70, 200, 0.25);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }

    .tile{
      transition: transform .1s ease, background-color .2s ease, box-shadow .2s ease;
    }
    .tile:hover{
      background: rgba(255,255,255,0.9);
      transform: scale(1.02);
      box-shadow: 0 8px 20px var(--nd-purple-weak);
    }

    .nd-input{
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      background: rgba(255,255,255,0.95);
    }

    #loadingOverlay{
      background: rgba(10,10,20,0.55);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }

    .text-lowlands{ color: var(--nd-purple); }

    #ownChipExplanation{
      font-family:'Poppins',sans-serif;
      font-size:0.9rem;
      color:#3a2768;
    }
  </style>
</head>

<body class="min-h-screen flex items-start justify-center p-6">

  <!-- GLOBALE LOADING OVERLAY -->
  <div id="loadingOverlay"
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display:none;">
    <div class="text-center text-white">
      <div class="inline-block w-16 h-16 rounded-full border-8 border-white/30 border-t-white animate-spin"></div>
      <div id="loadingText" class="mt-3">Bezig met laden...</div>
    </div>
  </div>

  <!-- MAIN CARD -->
  <main id="mainCard" class="w-full max-w-md rounded-3xl shadow-2xl p-6 min-h-[calc(100vh-3rem)] flex flex-col hidden">

    <!-- HEADER -->
    <header id="headerRoot">
      <img src="images/logo-ll26.PNG" alt="LL26" id="logoLl"/>
      <span class="logo-x" id="logoX" aria-hidden="true">×</span>
      <img src="images/nextdrink-logo.png" alt="NextDrink" id="logoNd"/>
    </header>

    <!-- ERROR BANNER -->
    <div id="errorBanner"
         class="hidden opacity-0 mb-3 rounded-2xl px-3 py-2 flex items-center gap-2 bg-[rgba(75,0,143,0.08)] border border-[rgba(75,0,143,0.25)] text-sm text-[var(--nd-purple)]">
      <span>⚠</span>
      <span id="errorBannerText">Er ging iets mis, probeer opnieuw.</span>
    </div>

    <!-- FIRST TIME / SET NAME (beiden onbekend) -->
    <section id="firstTime" class="text-center hidden flex-1 flex flex-col justify-center">
      <h3 class="nd-heading text-xl font-bold mb-3">Welkom!</h3>
      <p class="text-purple-800 mb-3">
        Dit is jouw eigen sticker.<br/>
        Vul je naam in om hem te personaliseren.
      </p>
      <input id="firstTimeNameInput" type="text" placeholder="Jouw naam" class="nd-input mb-3">
      <button id="firstTimeContinueBtn" class="nd-btn nd-cta w-full py-3 rounded-xl font-bold">
        Verder
      </button>
    </section>

    <!-- GEÏNTEGREERD NAAM-VELD (voor scenario 1 & 2) -->
    <section id="nameQuestion" class="hidden text-center flex-1 flex flex-col justify-center">
      <h3 id="nameQuestionTitle" class="nd-heading text-xl font-bold mb-3"></h3>
      <p id="nameQuestionBody" class="text-purple-800 mb-3"></p>
      <input id="nameQuestionInput" type="text" placeholder="Naam" class="nd-input mb-3">
      <button id="nameQuestionBtn" class="nd-btn nd-cta w-full py-3 rounded-xl font-bold">
        Verder
      </button>
    </section>
    <!-- POST-NAME INSTRUCTIONS (eigen sticker) -->
    <section id="postName" class="hidden text-center flex-1 flex flex-col justify-center">
      <h3 class="nd-heading text-lg font-semibold mb-2">Je bent klaar!</h3>
      <p class="text-purple-900 mb-3">
        Haal de <strong>QR-code</strong> van je sticker en plak het andere deel
        <strong>onderin op de achterkant</strong> van je telefoon.
      </p>
      <button id="postNameContinueBtn" class="nd-btn nd-cta mt-4 w-full py-3 rounded-xl font-bold">
        Verder
      </button>
    </section>

    <!-- MENU -->
    <section id="menu" class="hidden flex-1 flex flex-col">
      <h2 id="menuTitle" class="nd-heading text-lg font-semibold mb-3"></h2>

      <!-- Uitlegblok eigen sticker -->
      <div id="ownChipExplanation" class="hidden mb-4">
        <p class="mb-2">
          Dit is jouw <strong>eigen sticker</strong>. LLET'S SPLIT houdt bij
          wie welk rondje voor wie haalt.
        </p>
        <p class="mb-2">
          <strong>Als jij een rondje gaat halen</strong>, laat je je vrienden
          <strong>jouw sticker</strong> scannen.
        </p>
        <p class="mb-2">
          <strong>Als een vriend voor jou een drankje haalt</strong>, scan jij
          <strong>zijn sticker</strong>.
        </p>
        <p>
          Zo ontstaat er automatisch een eerlijk overzicht van alle rondjes,
          bestellingen en wat iedereen nog moet verrekenen.
        </p>
      </div>

      <!-- Drankjes-grid (alleen bij andermans sticker) -->
      <div id="drinks" class="grid grid-cols-2 gap-4 mb-4"></div>

      <!-- Knoppen -->
      <div class="grid grid-cols-1 gap-3 mt-auto">
        <button id="newDrinkScreenBtn" class="nd-btn nd-primary w-full py-3 rounded-xl font-semibold">
          + Nieuw drankje
        </button>
        <button id="bestelOverzichtBtn" class="nd-btn nd-cta w-full py-3 rounded-xl font-bold text-white">
          Bekijk bestellijst
        </button>
        <div class="flex gap-3 mt-2">
          <button id="scoresBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">
            Tussenstand
          </button>
          <button id="finalBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">
            Eindafrekening
          </button>
        </div>
      </div>
    </section>

    <!-- NEW DRINK SCREEN -->
    <section id="newDrink" class="hidden flex-1 flex flex-col">
      <h3 class="nd-heading font-bold mb-3">Nieuw drankje toevoegen</h3>
      <div class="flex flex-col gap-3 mb-3">
        <input id="newDrinkName" type="text" placeholder="Naam nieuw drankje" class="nd-input">
        <input id="newDrinkPrice" type="number" step="0.01" placeholder="Prijs (€)" class="nd-input">
      </div>
      <div class="flex gap-2 mt-auto">
        <button id="addDrinkBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Opslaan</button>
        <button id="cancelNewDrinkBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Annuleren</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="hidden text-center flex-1 flex flex-col justify-center">
      <div class="text-5xl">✅</div>
      <div id="confirmText" class="mt-3 font-semibold text-lowlands"></div>
      <div class="mt-4 flex gap-3">
        <button id="newRoundBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Nieuw rondje</button>
        <button id="confirmScoresBtn" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Tussenstand</button>
      </div>
    </section>

    <!-- SCORES -->
    <section id="scores" class="hidden flex-1 flex flex-col">
      <h3 class="nd-heading font-bold mb-2">Tussenstand</h3>
      <div id="scoreList" class="text-purple-900 flex-1"></div>
      <div class="mt-4">
        <button id="backToMenuFromScores" class="nd-btn nd-primary w-full py-3 rounded-xl font-bold">Terug</button>
      </div>
    </section>

    <!-- BESTELLIJST -->
    <section id="bestellijst" class="hidden flex-1 flex flex-col">
      <h3 class="nd-heading font-bold mb-2">Bestellijst (laatste 30 min)</h3>
      <div id="bestellijstContent" class="orders-wrap flex-1"></div>
      <div class="mt-4">
        <button id="backToMenuFromBestel" class="nd-btn nd-primary w-full py-3 rounded-xl font-bold">Terug</button>
      </div>
    </section>

    <!-- FINAL -->
    <section id="final" class="hidden flex-1 flex flex-col">
      <h3 class="nd-heading font-bold mb-2">Eindafrekening</h3>
      <div id="finalTotals" class="text-purple-900"></div>
      <div id="finalSettlements" class="text-purple-900 mt-2"></div>
      <div id="finalSettlementStatus" class="text-purple-900 mt-2"></div>
      <div class="mt-4 flex gap-2">
        <button id="markPaidBtn" class="nd-btn nd-cta flex-1 py-3 rounded-xl font-bold text-white">Ik wil afrekenen</button>
        <button id="backToMenuFromFinal" class="nd-btn nd-primary flex-1 py-3 rounded-xl font-bold">Terug</button>
      </div>
    </section>

  </main>

  <script>
    const $ = id => document.getElementById(id);
    const apiUrl = "https://script.google.com/macros/s/AKfycbxJaneXzY7PiSVMNSGnNDWnkYxh_4c45arWzxqrC9k6_MGV3o4mpRZv9ZZNiTdWoqEn/exec";

    // chipId uitlezen
    const chipIdRaw = new URLSearchParams(window.location.search).get('chipId');
    const chipId = (chipIdRaw && chipIdRaw !== 'null' && chipIdRaw !== 'undefined') ? chipIdRaw : null;
    const noChipMode = !chipId;

    let scannerName = (localStorage.getItem('scannerName') || '').trim();
    let chipOwner = '';
    let drinks = [];
    let isOwnChip = false;
    let myChipId = localStorage.getItem('myChipId') || null;

    // CACHE
    let chipCache = JSON.parse(localStorage.getItem("chipCache") || "{}");
    let drinksCache = JSON.parse(localStorage.getItem("drinksCache") || "null");
    let drinksCacheTime = parseInt(localStorage.getItem("drinksCacheTime") || "0", 10) || 0;

    const CACHE_DRINKS_MAX_AGE = 24*60*60*1000;
    const CACHE_REFRESH_INTERVAL = 5*60*1000;

    let nameQuestionMode = null;
    let errorTimeout = null;

    function showMain(){
      $("mainCard").classList.remove("hidden");
    }

    function showLoading(show, text='Bezig...') {
      const overlay = $('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
      $('loadingText').textContent = text;
      document.querySelectorAll('button').forEach(b => b.disabled = show);
    }

    function showError(message){
      const banner = $('errorBanner');
      const textEl = $('errorBannerText');
      if (!banner || !textEl) return;

      textEl.textContent = message || 'Er ging iets mis, probeer opnieuw.';
      banner.classList.remove('hidden');
      banner.classList.remove('opacity-0');
      banner.classList.add('opacity-100');

      if (errorTimeout) clearTimeout(errorTimeout);
      errorTimeout = setTimeout(() => {
        banner.classList.remove('opacity-100');
        banner.classList.add('opacity-0');
        setTimeout(() => {
          banner.classList.add('hidden');
        }, 250);
      }, 3000);
    }

    async function fetchWithTimeout(url, options={}, timeout=1200) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return res;
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    function hideAll() {
      [
        'menu','confirm','scores','final',
        'firstTime','bestellijst','newDrink',
        'postName','nameQuestion'
      ].forEach(id => $(id)?.classList.add('hidden'));
    }

    function escapeHtml(str){
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // DRANKEN LADEN MET CACHE
    async function loadDrinks(){
      const NOW = Date.now();
      if (drinksCache && (NOW - drinksCacheTime) < CACHE_DRINKS_MAX_AGE){
        drinks = drinksCache;
        return;
      }
      try{
        const resp = await fetchWithTimeout(`${apiUrl}?action=getDrinks`, {}, 1500);
        const list = await resp.json();
        drinks = list;
        drinksCache = list;
        drinksCacheTime = NOW;
        localStorage.setItem("drinksCache", JSON.stringify(list));
        localStorage.setItem("drinksCacheTime", NOW.toString());
      }catch(e){
        console.error("Fout bij drinks laden:", e);
        if (drinksCache){
          drinks = drinksCache;
        } else {
          drinks = [
            {name:'Kleine bier',price:4.4},
            {name:'Grote bier',price:8},
            {name:'Desperados',price:6.5},
            {name:'Wijn',price:6},
            {name:'0.0 bier',price:4},
            {name:'Frisdrank',price:4}
          ];
        }
      }
    }

    // PERIODIEKE REFRESH OWNERS & DRINKS
    async function refreshCaches(){
      try{
        const rD = await fetchWithTimeout(`${apiUrl}?action=getDrinks`,{},1500);
        const newDrinks = await rD.json();
        drinksCache = newDrinks;
        drinksCacheTime = Date.now();
        localStorage.setItem("drinksCache", JSON.stringify(newDrinks));
        localStorage.setItem("drinksCacheTime", drinksCacheTime.toString());

        const rO = await fetchWithTimeout(`${apiUrl}?action=getAllOwners`,{},1500);
        const owners = await rO.json();
        chipCache = owners;
        localStorage.setItem("chipCache", JSON.stringify(owners));
      }catch(e){
        console.warn("Periodic sync failed", e);
      }
    }
    setInterval(refreshCaches, CACHE_REFRESH_INTERVAL);

    function updateOwnChipFlag(){
      if (chipId && myChipId && myChipId === chipId){
        isOwnChip = true;
      }
      if (scannerName && chipOwner && scannerName === chipOwner){
        isOwnChip = true;
        if (chipId) {
          localStorage.setItem('myChipId', chipId);
          myChipId = chipId;
        }
      }
    }

    async function resolveOwnerWithAutoSync(){
      if (!chipId) {
        chipOwner = "";
        return;
      }

      const cachedOwner = chipCache[chipId] || "";
      let sheetOwner = "";

      try{
        const resp = await fetchWithTimeout(
          `${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`,
          {},
          800
        );
        sheetOwner = (await resp.text()).trim();
      }catch(e){
        console.error("Fout bij getOwner:", e);
        sheetOwner = "";
      }

      // OWNER BESTAAT ALTIJD PRIORITEIT
      if (sheetOwner){
        chipOwner = sheetOwner;
        chipCache[chipId] = sheetOwner;
        localStorage.setItem("chipCache", JSON.stringify(chipCache));
      }
      else if (cachedOwner){
        chipOwner = cachedOwner;

        // probeer alsnog sheet te syncen
        fetch(apiUrl, {
          method:'POST',
          body:new URLSearchParams({
            action:'setOwner',
            chipId,
            owner: cachedOwner
          })
        }).catch(err => console.error("Auto-sync setOwner fail:", err));

      } else {
        chipOwner = "";
      }
    }

    async function handleNameLogic(){
      if (noChipMode) {
        updateOwnChipFlag();
        return "menu";
      }

      const hasScanner = !!scannerName;
      const hasOwner   = !!chipOwner;

      // 4. beide bekend → direct naar menu
      if (hasScanner && hasOwner){
        updateOwnChipFlag();
        return "menu";
      }

      // 1. chipOwner bekend, scanner niet → 'Je hebt de sticker van Bob gescand'
      if (hasOwner && !hasScanner){
        nameQuestionMode = 'askScanner';
        hideAll();
        $('nameQuestionTitle').textContent = 'Wie ben jij?';
        $('nameQuestionBody').innerHTML =
          `Je hebt de sticker van <strong>${escapeHtml(chipOwner)}</strong> gescand. Wat is jouw eigen naam?`;
        $('nameQuestionInput').value = '';
        $('nameQuestion').classList.remove('hidden');
        return "nameQuestion";
      }

      // 2. scanner bekend, owner niet → maar alleen als sticker NOOIT eerder eigenaar had
      if (!hasOwner && hasScanner){

        const previousOwner = chipCache[chipId];

        // PERMANENTE OVERSCHRIJFBEVEILIGING
        if (previousOwner) {
          chipOwner = previousOwner;
          hideAll();
          renderMenu();
          return "menu";
        }

        nameQuestionMode = 'askOwner';
        hideAll();
        $('nameQuestionTitle').textContent = 'Sticker nog niet gekoppeld';
        $('nameQuestionBody').textContent =
          'Deze sticker is nog niet gekoppeld, van wie is de sticker die je scande?';
        $('nameQuestionInput').value = '';
        $('nameQuestion').classList.remove('hidden');
        return "nameQuestion";
      }

      // 3. beiden onbekend → firstTime scherm
      if (!hasOwner && !hasScanner){
        hideAll();
        $('firstTime').classList.remove('hidden');
        return "firstTime";
      }

      return "menu";
    }

    async function init(){
      showLoading(true,'Initialiseren...');
      try{
        await loadDrinks();

        if (noChipMode){
          chipOwner = scannerName || '';
          isOwnChip = false;
          showMain();
          hideAll();
          renderMenu();
          return;
        }

        await resolveOwnerWithAutoSync();

        if (chipId && myChipId && myChipId === chipId){
          isOwnChip = true;
        }

        const state = await handleNameLogic();
        showMain();

        if (state === "menu"){
          hideAll();
          renderMenu();
        }

      }catch(err){
        console.error('Fout bij initialiseren:', err);
        showMain();
        hideAll();
        renderMenu();
        showError('Er ging iets mis, probeer opnieuw.');
      }finally{
        showLoading(false);
      }
    }

    // FIRST TIME FLOW
    $('firstTimeContinueBtn').onclick = async ()=>{
      const name = $('firstTimeNameInput').value.trim();
      if(!name){
        showError('Voer een naam in.');
        return;
      }
      showLoading(true,'Verwerken...');

      scannerName = name;
      chipOwner   = name;
      localStorage.setItem('scannerName', scannerName);

      try{
        if (chipId){
          await fetch(apiUrl, {
            method:'POST',
            body:new URLSearchParams({action:'setOwner', chipId, owner:chipOwner})
          });
          chipCache[chipId] = chipOwner;
          localStorage.setItem("chipCache", JSON.stringify(chipCache));

          localStorage.setItem('myChipId', chipId);
          myChipId = chipId;
          isOwnChip = true;
        }
      }catch(e){
        console.error(e);
        showError('Er ging iets mis, probeer opnieuw.');
      }finally{
        showLoading(false);
      }

      hideAll();
      $('postName').classList.remove('hidden');
    };

    $('postNameContinueBtn').onclick = ()=>{
      hideAll();
      renderMenu();
    };

    // NAAMVRAAG HANDLER
    $('nameQuestionBtn').onclick = async ()=>{
      const val = $('nameQuestionInput').value.trim();
      if(!val){
        showError('Voer een naam in.');
        return;
      }
      showLoading(true,'Verwerken...');

      try{

        // === ABSOLUTE OVERSCHRIJF BEVEILIGING ===
        if (nameQuestionMode === 'askOwner' && chipCache[chipId]) {
          chipOwner = chipCache[chipId];
          hideAll();
          renderMenu();
          return;
        }

        if (nameQuestionMode === 'askScanner'){
          scannerName = val;
          localStorage.setItem('scannerName', scannerName);
        }
        else if (nameQuestionMode === 'askOwner'){
          chipOwner = val;
          if (chipId){
            await fetch(apiUrl, {
              method:"POST",
              body:new URLSearchParams({action:"setOwner", chipId, owner:chipOwner})
            });
            chipCache[chipId] = chipOwner;
            localStorage.setItem("chipCache", JSON.stringify(chipCache));
          }
        }

        updateOwnChipFlag();
        hideAll();
        renderMenu();

      }catch(e){
        console.error('Fout bij verwerken naamvraag:', e);
        showError('Er ging iets mis, probeer opnieuw.');
        hideAll();
        renderMenu();
      }finally{
        showLoading(false);
      }
    };

    /* REST VAN JE CODE (menu rendering, drankjes, bestellijst,
       scores, eindafrekening) BLIJFT IDENTIEK EN ONGEBRUIKT
       VOOR DE BUGFIX — GEEN AANPASSINGEN HIER BENEDEN */

    window.addEventListener('DOMContentLoaded', init);
  </script>

</body>
</html>
