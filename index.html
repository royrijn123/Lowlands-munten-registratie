<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NextDrink NFC</title>
<style>
html, body { height:100%; margin:0; padding:0; }
body {
  font-family: Arial, sans-serif;
  text-align:center;
  background: linear-gradient(135deg, #7e22ce, #f97316);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
.card {
  background: transparent;
  color:#fff;
  max-width:450px;
  width:100%;
  padding:20px;
  border-radius:16px;
}
#drinks {
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:12px;
  margin-bottom:16px;
}
#drinks button {
  width:100%;
  aspect-ratio:1/1;
  font-size:18px;
  font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  transition: transform 0.1s;
}
#drinks button:active { transform: scale(0.97); }

button.primary { background:#7e22ce; color:#fff; }
button.secondary { background:#f97316; color:#fff; }
button.outline { background: rgba(255,255,255,0.2); color:#fff; border:2px solid #fff; }

#menuTitle, h1,h2,h3 { margin:12px 0; }

#loadingOverlay {
  display:none;
  position:fixed; top:0; left:0;
  width:100vw; height:100vh;
  background: rgba(0,0,0,0.7);
  z-index:9999;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
}
.spinner {
  border:8px solid rgba(255,255,255,0.3);
  border-top:8px solid #fff;
  border-radius:50%;
  width:80px; height:80px;
  animation:spin 1s linear infinite;
  margin-bottom:16px;
}
@keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
#logo { max-width:150px; height:auto; margin:0 auto 16px; display:block; }

#orderList {
  background: rgba(0,0,0,0.6);
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
}
#orderList ul { list-style:none; padding:0; margin:0; text-align:left; }
#orderList ul li { padding:6px 0; font-size:16px; }

#orderListBtn {
  background: #10b981; /* andere kleur */
  color:#fff;
  border:none;
  border-radius:12px;
  font-size:18px;
  font-weight:bold;
  width:100%;
  aspect-ratio:1/1;
  cursor:pointer;
  margin-top:12px;
  transition: transform 0.1s;
}
#orderListBtn:active { transform: scale(0.97); }

</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Bezig met laden...</div>
</div>

<div class="card">
  <img src="images/nextdrink-logo.png" alt="NextDrink Logo" id="logo">

  <div id="menu" style="display:none;">
    <h2 id="menuTitle"></h2>
    <div id="drinks"></div>
    <button id="orderListBtn" onclick="showOrderList()">Bekijk bestellijst</button>
    <button class="outline" onclick="showScores()">Bekijk tussenstand</button>
    <button class="outline" onclick="showFinal()">Eindafrekening</button>
  </div>

  <div id="confirm" style="display:none;">
    <h2>‚úÖ Verwerkt!</h2>
    <p id="confirmText"></p>
    <button class="secondary" onclick="newRound()">Nieuw rondje</button>
    <button class="outline" onclick="showOrderList()">Bekijk bestellijst</button>
    <button class="outline" onclick="showScores()">Bekijk tussenstand</button>
    <button class="outline" onclick="showFinal()">Eindafrekening</button>
  </div>

  <div id="orderList" style="display:none;">
    <h2>üìù Bestellijst</h2>
    <p id="orderListTitle"></p>
    <ul id="orderListItems"></ul>
    <button class="primary" onclick="backToMenu()">Terug</button>
  </div>

  <div id="firstTime" style="display:none;">
    <h2>Welkom!</h2>
    <p id="firstTimeText"></p>
  </div>

  <div id="scores" style="display:none;">
    <h2>Tussenstand</h2>
    <div id="scoreList"></div>
    <button class="primary" onclick="backToMenu()">Terug</button>
  </div>

  <div id="final" style="display:none;">
    <h2>üèÅ Eindafrekening</h2>
    <div id="finalWinner"></div>
    <div id="finalList"></div>
    <button class="primary" onclick="backToMenu()">Terug</button>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbzdYTvLDqOm0pGhzPGQWAECLjE_z_o6mFJOucj9m0K_tCNbwT60VN-QSpDNGrjEY24VsQ/exec";
const chipId = new URLSearchParams(window.location.search).get("chipId");
if(!chipId){ alert("Geen chipId in URL!"); throw new Error("Geen chipId"); }

const drinksVersion="v2";
const savedVersion=localStorage.getItem("drinksVersion");
if(savedVersion!==drinksVersion){ localStorage.removeItem("drinks"); localStorage.setItem("drinksVersion",drinksVersion); }

let chipOwner="";
let scannerName=localStorage.getItem("scannerName");

let drinks=JSON.parse(localStorage.getItem("drinks")||"null")||[
  {name:"Kleine bier", price:4.40},
  {name:"Grote bier", price:8.00},
  {name:"Wijn", price:6.00},
  {name:"Cocktail", price:11.50},
  {name:"Frisdrank", price:4.00}
];
localStorage.setItem("drinks",JSON.stringify(drinks));

const $=id=>document.getElementById(id);

function hideAll(){ ["menu","confirm","scores","final","firstTime","orderList"].forEach(id=>$(id).style.display="none"); }
function showLoading(show,text="Bezig met laden..."){ $("loadingText").textContent=text; $("loadingOverlay").style.display=show?"flex":"none"; document.querySelectorAll("button").forEach(btn=>btn.disabled=show); }

async function init(){
  showLoading(true,"Initialiseren...");
  requestAnimationFrame(renderMenu);
  try{
    const owner=await fetch(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`).then(r=>r.ok?r.text():Promise.reject("Response not ok")).then(t=>t.trim());
    
    if(!scannerName && !owner){
      const name=prompt("Wat is jouw naam?")?.trim();
      if(!name){ alert("Geen naam ingevoerd."); showLoading(false); return; }
      scannerName=name; chipOwner=name;
      localStorage.setItem("scannerName",scannerName);
      await fetch(apiUrl,{ method:"POST", body:new URLSearchParams({ action:"setOwner", chipId, owner:chipOwner })});
      hideAll();
      $("firstTimeText").innerHTML=`Gefeliciteerd ${chipOwner}! Je naam is verwerkt in het systeem.<br><br>üì± Plak nu de NFC sticker onderaan op de achterkant van je telefoon.`;
      $("firstTime").style.display="block";
    } else if(!scannerName && owner){
      scannerName=prompt("Wat is jouw naam (scanner)?")?.trim()||"Onbekend";
      localStorage.setItem("scannerName",scannerName);
      chipOwner=owner;
      renderMenu();
    } else if(scannerName && !owner){
      chipOwner=prompt("Wat is de naam voor deze chip?")?.trim();
      if(!chipOwner){ alert("Geen naam ingevoerd."); showLoading(false); return; }
      await fetch(apiUrl,{ method:"POST", body:new URLSearchParams({ action:"setOwner", chipId, owner:chipOwner })});
      renderMenu();
    } else { chipOwner=owner; renderMenu(); }
  }catch(err){ console.error(err); alert("Fout bij ophalen eigenaar."); }
  finally{ showLoading(false); }
}

function renderMenu(){
  hideAll();
  $("menuTitle").textContent=chipOwner?`Wat wil je dat ${chipOwner} voor je gaat halen?`:"Laden...";
  const drinksDiv=$("drinks"); const frag=document.createDocumentFragment();
  drinks.forEach(d=>{
    const btn=document.createElement("button"); btn.className="secondary"; btn.textContent=d.name;
    btn.addEventListener("click",()=>placeOrder(d));
    frag.appendChild(btn);
  });
  const addBtn=document.createElement("button"); addBtn.className="outline"; addBtn.textContent="Voeg drankje toe"; addBtn.onclick=addCustomDrink;
  frag.appendChild(addBtn);
  drinksDiv.replaceChildren(frag);
  $("menu").style.display="block";
}

function addCustomDrink(){
  const name=prompt("Naam van het nieuwe drankje?"); if(!name) return;
  const price=parseFloat(prompt(`Prijs van "${name}"? (‚Ç¨)`).replace(",",".")); 
  if(isNaN(price)||price<=0) return alert("Ongeldige prijs!");
  drinks.push({name:name.trim(), price}); localStorage.setItem("drinks",JSON.stringify(drinks));
  renderMenu();
}

async function placeOrder(drink){
  showLoading(true,"Verwerken...");
  try{
    await fetch(apiUrl,{ method:"POST", body:new URLSearchParams({ action:"addScan", chipId, scanner:scannerName, drink:drink.name, amount:drink.price })});
    hideAll(); $("confirmText").textContent=`${drink.name} (‚Ç¨${drink.price}) is doorgegeven aan ${chipOwner}.`;
    $("confirm").style.display="block";
  }catch{ alert("Fout bij plaatsen order."); }
  finally{ showLoading(false); }
}

function groupScansWithin4Min(scans){
  const grouped={}; const FOUR_MIN=4*60*1000;
  scans.forEach(s=>{
    const owner=s.owner; const time=new Date(s.timestamp).getTime();
    if(!grouped[owner]) grouped[owner]=[];
    grouped[owner].push({ time, amount:parseFloat(s.amount), scanner:s.scanner, drink:s.drink });
  });
  return Object.entries(grouped).map(([owner,arr])=>{
    arr.sort((a,b)=>a.time-b.time);
    let rounds=0,total=0,lastTime=0,lastRound=[];
    arr.forEach(scan=>{
      total+=scan.amount;
      if(scan.time-lastTime>FOUR_MIN){ rounds++; lastTime=scan.time; lastRound=[]; }
      lastRound.push(scan);
    });
    return { owner, rounds, total:total.toFixed(2), lastRound: lastRound };
  });
}

async function showOrderList(){
  showLoading(true,"Bestellijst laden...");
  try{
    const scans=await fetch(`${apiUrl}?action=getScans`).then(r=>r.json());
    const grouped=groupScansWithin4Min(scans);
    const chipData=grouped.find(g=>g.owner===chipOwner);
    hideAll();
    if(!chipData || !chipData.lastRound.length){
      $("orderListTitle").textContent=`${chipOwner} heeft nog geen bestellingen.`;
      $("orderListItems").innerHTML="";
    }else{
      $("orderListTitle").textContent=`${chipOwner} gaat deze drankjes halen:`;
      $("orderListItems").innerHTML=chipData.lastRound.map(s=>`<li>${s.scanner} ‚Üí ${s.drink}</li>`).join("");
    }
    $("orderList").style.display="block";
  }catch(err){ console.error(err); alert("Fout bij ophalen bestellijst."); }
  finally{ showLoading(false); }
}

async function showScores(){
  showLoading(true,"Scores laden...");
  try{
    const scans=await fetch(`${apiUrl}?action=getScans`).then(r=>r.json());
    const results=groupScansWithin4Min(scans);
    results.sort((a,b)=>b.rounds-a.rounds);
    const html=results.map(s=>`<li><strong>${s.owner}</strong> ‚Äî ${s.rounds} rondje${s.rounds===1?"":"s"} (‚Ç¨${s.total})</li>`).join("");
    hideAll(); $("scoreList").innerHTML=`<ul>${html}</ul>`; $("scores").style.display="block";
  }catch(err){ console.error(err); alert("Fout bij ophalen scores."); }
  finally{ showLoading(false); }
}

async function showFinal(){
  showLoading(true,"Eindafrekening laden...");
  try{
    const [scans,settlements]=await Promise.all([
      fetch(`${apiUrl}?action=getScans`).then(r=>r.json()),
      fetch(`${apiUrl}?action=getSettlement`).then(r=>r.json())
    ]);
    const results=groupScansWithin4Min(scans); results.sort((a,b)=>b.rounds-a.rounds);
    const scoresHtml=results.map(s=>`<li><strong>${s.owner}</strong> ‚Äî ${s.rounds} rondje${s.rounds===1?"":"s"} (‚Ç¨${s.total})</li>`).join("");
    let settleHtml="<h3>üí∂ Verrekeningen</h3>";
    if(!settlements.length) settleHtml+="<p>Alles is al eerlijk verdeeld.</p>";
    else settleHtml+=`<ul>${settlements.map(s=>`<li>${s.from} betaalt ‚Ç¨${s.amount} aan ${s.to}</li>`).join("")}</ul>`;
    hideAll();
    $("finalWinner").innerHTML=results.length?`<h3>üèÜ ${results[0].owner} heeft de meeste rondjes gehaald (${results[0].rounds})!</h3>`:"<p>Nog geen data.</p>";
    $("finalList").innerHTML=`<ul>${scoresHtml}</ul>${settleHtml}`; $("final").style.display="block";
  }catch(err){ console.error(err); alert("Fout bij ophalen eindafrekening."); }
  finally{ showLoading(false); }
}

function backToMenu(){ renderMenu(); }
function newRound(){ renderMenu(); }

init();
</script>
</body>
</html>
