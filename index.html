<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Lowlands Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .btn {
      width: 100%;
      height: calc((100vh - 60px) / 3);
      font-size: 5em;
      border: none;
      color: white;
      cursor: pointer;
      display: none; /* start onzichtbaar */
    }
    .btn-1 { background-color: #3498db; }
    .btn-15 { background-color: #f1c40f; }
    .btn-2 { background-color: #e74c3c; }
    #spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 80px;
      height: 80px;
      margin: -40px 0 0 -40px;
      border: 10px solid #f3f3f3;
      border-top: 10px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 999;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="spinner"></div>
  <button class="btn btn-1" onclick="sendAmount(1)">1 munt (‚Ç¨3,90)</button>
  <button class="btn btn-15" onclick="sendAmount(1.5)">1,5 munt (‚Ç¨5,90)</button>
  <button class="btn btn-2" onclick="sendAmount(2)">2 munten (‚Ç¨7,80)</button>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbx4S27sMxt7KtLbCD1X3cMmM8xbyVsuQZTwOxmwjIf0IVzqcoJUHi7C0x8xND13spnFtQ/exec";
    const chipId = new URLSearchParams(window.location.search).get("chipId");
    if (!chipId) { alert("Geen chipId in URL"); throw new Error("Geen chipId"); }

    let chipOwner = "";
    let scannerName = localStorage.getItem("scannerName");

    function showSpinner() { document.getElementById("spinner").style.display = "block"; }
    function hideSpinner() { document.getElementById("spinner").style.display = "none"; }

    async function init() {
      // Ophalen chiphouder via GET
      const resp = await fetch(`${apiUrl}?action=getOwner&chipId=${encodeURIComponent(chipId)}`);
      const owner = (await resp.text()).trim();

      if (owner) {
        chipOwner = owner;
      } else {
        chipOwner = prompt("Van wie is deze chip?");
        if (chipOwner) {
          await fetch(apiUrl, {
            method: "POST",
            body: new URLSearchParams({ action: "setOwner", chipId, owner: chipOwner })
          });
        } else {
          alert("Je moet een naam invoeren!");
          return init(); // opnieuw proberen
        }
      }

      if (!scannerName) {
        scannerName = prompt(`Je scande de chip van ${chipOwner}. Wat is jouw naam?`);
        if (scannerName) {
          localStorage.setItem("scannerName", scannerName);
        } else {
          alert("Je moet een naam invoeren!");
          return init(); // opnieuw proberen
        }
      }

      // Toon knoppen pas NA init
      document.querySelectorAll(".btn").forEach(b => b.style.display = "block");
    }

    async function sendAmount(amount) {
      // Extra check: mocht init niet afgerond zijn
      if (!chipOwner) {
        chipOwner = prompt("Van wie is deze chip?");
      }
      if (!scannerName) {
        scannerName = prompt("Wat is jouw naam?");
        if (scannerName) {
          localStorage.setItem("scannerName", scannerName);
        }
      }

      document.querySelectorAll(".btn").forEach(b => b.disabled = true);
      showSpinner();

      try {
        const resp = await fetch(apiUrl, {
          method: "POST",
          body: new URLSearchParams({
            action: "scan",
            chipId,
            owner: chipOwner,
            scanner: scannerName,
            amount
          })
        });
        await resp.text();

        alert(`‚úÖ Je hebt ${amount} munt(en) gegeven aan ${chipOwner}`);
        document.querySelectorAll(".btn").forEach(b => b.style.display = "none");

        const msg = document.createElement("div");
        msg.style.fontSize = "3em";
        msg.style.marginTop = "20vh";
        msg.style.color = "#3498db";
        msg.textContent = "Topper! Geniet van je bestelling!üçª";
        document.body.appendChild(msg);

      } catch (err) {
        console.error(err);
        alert("‚ùå Mislukt‚Ä¶ probeer opnieuw!");
      } finally {
        hideSpinner();
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
